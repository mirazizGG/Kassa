<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Do'kon Tizimi - 2.1.0</title>
    <!-- CSS Libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
        }

        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
            color: white;
        }

        .nav-link {
            color: rgba(255, 255, 255, .8);
            padding: 12px 20px;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, .1);
            color: white;
            border-left: 4px solid #3498db;
        }

        .main-content {
            padding: 30px;
        }

        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            border-radius: 0.5rem;
        }

        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }

        /* POS Styles */
        .pos-product-card {
            cursor: pointer;
            transition: transform .2s;
            height: 100%;
            border: 1px solid #e3e6f0;
        }

        .pos-product-card:hover {
            transform: translateY(-5px);
            border-color: #4e73df;
        }

        /* Fullscreen Mode */
        .fullscreen-mode .sidebar {
            display: none !important;
        }

        .fullscreen-mode #section-pos {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 9999;
            background: #f4f6f9;
            overflow-y: auto;
            padding: 20px;
        }

        .fullscreen-mode .main-content {
            display: none;
        }

        .fullscreen-mode #section-pos {
            display: block !important;
        }

        #fullscreen-exit-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            display: none;
        }

        /* Kassir rejimida chiqish tugmasi yashirin */
        .fullscreen-mode.cashier-locked #fullscreen-exit-btn {
            display: none !important;
        }

        /* Faqat admin/menejer uchun chiqish tugmasi ko'rinadi */
        .fullscreen-mode:not(.cashier-locked) #fullscreen-exit-btn {
            display: block;
        }

        /* Kassir modal overlay */
        #cashier-section-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 30px;
            overflow-y: auto;
        }

        #cashier-section-modal.show {
            display: flex;
        }

        #cashier-section-modal .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #cashier-section-modal .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        #cashier-section-modal .modal-body {
            padding: 25px;
        }

        #cashier-section-modal .close-modal-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f1f1f1;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #cashier-section-modal .close-modal-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* Kassir mini toolbar (pastda) */
        #cashier-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }

        /* Kassir uchun toolbar doim ko'rinadi */
        body.role-cashier #cashier-toolbar {
            display: flex;
        }

        /* Kassir uchun sidebar yashirin */
        body.role-cashier .sidebar {
            display: none !important;
        }

        /* Kassir uchun main content to'liq ekran */
        body.role-cashier .flex-grow-1 {
            margin-left: 0 !important;
            padding-bottom: 70px;
        }

        body.role-cashier .col-md-2[style*="width: 280px"] {
            display: none !important;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toolbar-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .toolbar-btn.btn-danger-soft {
            background: rgba(231, 76, 60, 0.3);
        }

        .toolbar-btn.btn-danger-soft:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .toolbar-info {
            color: white;
            font-size: 14px;
        }

        .toolbar-info .balance {
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
        }

        /* Eski FAB panelni o'chirish */
        #cashier-quick-panel {
            display: none !important;
        }

        /* Eski shift info ni o'chirish */
        #fullscreen-shift-info {
            display: none !important;
        }

        /* Kassir rejimida POS pastdan joy qoldirish */
        .cashier-locked #section-pos {
            padding-bottom: 80px !important;
        }

        /* Fullscreen rejimda POS yaxshilash */
        .fullscreen-mode #section-pos h3 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .fullscreen-mode .pos-product-card {
            transition: all 0.2s ease;
        }

        .fullscreen-mode .pos-product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Kassir uchun katta savat summasi */
        .fullscreen-mode #pos-total-price {
            font-size: 1.8rem;
        }

        .fullscreen-mode .btn-lg {
            padding: 15px 30px;
            font-size: 1.2rem;
        }

        /* Kassir rejimida fullscreen toggle tugmasini yashirish */
        .cashier-locked #fullscreen-toggle-btn {
            display: none !important;
        }

        /* Kassir rejimida POS sarlavhasini soddalashtirish */
        .cashier-locked #section-pos h3 {
            display: none;
        }

        .cashier-locked #section-pos #pos-search {
            font-size: 1.1rem;
            padding: 12px 15px;
        }

        /* ============================================= */
        /* ================ DARK MODE ================== */
        /* ============================================= */

        /* Dark mode toggle button */
        .dark-mode-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .dark-mode-toggle i {
            font-size: 1.1rem;
        }

        /* Dark mode body */
        body.dark-mode {
            background-color: #1a1a2e !important;
            color: #e4e4e4 !important;
        }

        /* Sidebar dark mode */
        body.dark-mode .sidebar {
            background: #16213e !important;
        }

        body.dark-mode .sidebar .bg-white {
            background: rgba(255,255,255,0.05) !important;
        }

        /* Main content area */
        body.dark-mode .bg-light {
            background-color: #1a1a2e !important;
        }

        body.dark-mode .main-content {
            background: transparent;
        }

        /* Cards */
        body.dark-mode .card {
            background-color: #16213e !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .card-header {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .card-body {
            background-color: #16213e !important;
        }

        /* Tables */
        body.dark-mode .table {
            color: #e4e4e4 !important;
            --bs-table-bg: #16213e;
            --bs-table-striped-bg: #1f2b47;
            --bs-table-hover-bg: #253454;
            border-color: #2d3a5f !important;
        }

        body.dark-mode .table thead th {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .table td,
        body.dark-mode .table th {
            border-color: #2d3a5f !important;
        }

        /* Forms */
        body.dark-mode .form-control {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .form-control:focus {
            background-color: #253454 !important;
            border-color: #4e73df !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25) !important;
        }

        body.dark-mode .form-control::placeholder {
            color: #8e9aaf !important;
        }

        body.dark-mode .form-select {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .form-label {
            color: #b8c5db !important;
        }

        body.dark-mode .input-group-text {
            background-color: #253454 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        /* Modals */
        body.dark-mode .modal-content {
            background-color: #16213e !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .modal-header {
            border-color: #2d3a5f !important;
        }

        body.dark-mode .modal-footer {
            border-color: #2d3a5f !important;
        }

        /* Alerts */
        body.dark-mode .alert-warning {
            background-color: rgba(255, 193, 7, 0.15) !important;
            border-color: rgba(255, 193, 7, 0.3) !important;
            color: #ffc107 !important;
        }

        body.dark-mode .alert-success {
            background-color: rgba(40, 167, 69, 0.15) !important;
            border-color: rgba(40, 167, 69, 0.3) !important;
            color: #28a745 !important;
        }

        body.dark-mode .alert-danger {
            background-color: rgba(220, 53, 69, 0.15) !important;
            border-color: rgba(220, 53, 69, 0.3) !important;
            color: #dc3545 !important;
        }

        body.dark-mode .alert-info {
            background-color: rgba(23, 162, 184, 0.15) !important;
            border-color: rgba(23, 162, 184, 0.3) !important;
            color: #17a2b8 !important;
        }

        /* POS product cards */
        body.dark-mode .pos-product-card {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
        }

        body.dark-mode .pos-product-card:hover {
            border-color: #4e73df !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        body.dark-mode .pos-product-card .card-title {
            color: #e4e4e4 !important;
        }

        body.dark-mode .pos-product-card .text-muted {
            color: #8e9aaf !important;
        }

        /* List groups */
        body.dark-mode .list-group-item {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .list-group-item-action:hover {
            background-color: #253454 !important;
        }

        /* Borders and separators */
        body.dark-mode hr {
            border-color: #2d3a5f !important;
        }

        body.dark-mode .border-bottom {
            border-color: #2d3a5f !important;
        }

        /* Text colors */
        body.dark-mode .text-muted {
            color: #8e9aaf !important;
        }

        body.dark-mode .text-dark {
            color: #e4e4e4 !important;
        }

        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5,
        body.dark-mode h6 {
            color: #e4e4e4 !important;
        }

        /* SweetAlert2 dark mode */
        body.dark-mode .swal2-popup {
            background-color: #16213e !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .swal2-title {
            color: #e4e4e4 !important;
        }

        body.dark-mode .swal2-html-container {
            color: #b8c5db !important;
        }

        body.dark-mode .swal2-input {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .swal2-select {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        /* Cashier modal dark mode */
        body.dark-mode #cashier-section-modal .modal-content {
            background: #16213e !important;
        }

        body.dark-mode #cashier-section-modal .modal-header {
            background: #1f2b47 !important;
            border-color: #2d3a5f !important;
        }

        body.dark-mode #cashier-section-modal .close-modal-btn {
            background: #253454 !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode #cashier-section-modal .close-modal-btn:hover {
            background: #e74c3c !important;
            color: white !important;
        }

        /* Fullscreen mode dark */
        body.dark-mode.fullscreen-mode #section-pos {
            background: #1a1a2e !important;
        }

        /* Badges */
        body.dark-mode .badge.bg-light {
            background-color: #253454 !important;
            color: #e4e4e4 !important;
        }

        /* Buttons outline */
        body.dark-mode .btn-outline-secondary {
            color: #8e9aaf !important;
            border-color: #2d3a5f !important;
        }

        body.dark-mode .btn-outline-secondary:hover {
            background-color: #253454 !important;
            border-color: #3d4a6f !important;
            color: #e4e4e4 !important;
        }

        /* Pagination */
        body.dark-mode .page-link {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .page-link:hover {
            background-color: #253454 !important;
        }

        /* Reports section */
        body.dark-mode .bg-primary {
            background-color: #4e73df !important;
        }

        body.dark-mode .bg-success {
            background-color: #28a745 !important;
        }

        body.dark-mode .bg-info {
            background-color: #17a2b8 !important;
        }

        /* Dropdown */
        body.dark-mode .dropdown-menu {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
        }

        body.dark-mode .dropdown-item {
            color: #e4e4e4 !important;
        }

        body.dark-mode .dropdown-item:hover {
            background-color: #253454 !important;
        }

        /* UMUMIY MATN RANGLARI - DARK MODE */
        body.dark-mode,
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode div,
        body.dark-mode label,
        body.dark-mode td,
        body.dark-mode th,
        body.dark-mode li,
        body.dark-mode a:not(.btn):not(.nav-link) {
            color: #e4e4e4 !important;
        }

        /* Jadval ichidagi matnlar */
        body.dark-mode .table td,
        body.dark-mode .table th,
        body.dark-mode .table tbody tr td {
            color: #e4e4e4 !important;
        }

        /* Card ichidagi barcha matnlar */
        body.dark-mode .card *:not(.btn):not(.badge):not(.nav-link):not(i) {
            color: #e4e4e4;
        }

        body.dark-mode .card-title,
        body.dark-mode .card-text {
            color: #e4e4e4 !important;
        }

        /* Strong va bold matnlar */
        body.dark-mode strong,
        body.dark-mode b {
            color: #ffffff !important;
        }

        /* Small va muted matnlar */
        body.dark-mode small,
        body.dark-mode .small {
            color: #a0aec0 !important;
        }

        /* Text utilities */
        body.dark-mode .text-body {
            color: #e4e4e4 !important;
        }

        body.dark-mode .text-secondary {
            color: #a0aec0 !important;
        }

        body.dark-mode .text-black,
        body.dark-mode .text-dark {
            color: #e4e4e4 !important;
        }

        /* Qarz summasi (manfiy balans) */
        body.dark-mode .text-danger {
            color: #ff6b6b !important;
        }

        body.dark-mode .text-success {
            color: #51cf66 !important;
        }

        body.dark-mode .text-warning {
            color: #fcc419 !important;
        }

        body.dark-mode .text-info {
            color: #66d9e8 !important;
        }

        /* Button matnlari (outline) */
        body.dark-mode .btn-outline-primary {
            color: #74b9ff !important;
            border-color: #74b9ff !important;
        }

        body.dark-mode .btn-outline-danger {
            color: #ff6b6b !important;
            border-color: #ff6b6b !important;
        }

        body.dark-mode .btn-outline-success {
            color: #51cf66 !important;
            border-color: #51cf66 !important;
        }

        body.dark-mode .btn-outline-warning {
            color: #fcc419 !important;
            border-color: #fcc419 !important;
        }

        body.dark-mode .btn-outline-info {
            color: #66d9e8 !important;
            border-color: #66d9e8 !important;
        }

        /* Links */
        body.dark-mode a {
            color: #74b9ff;
        }

        body.dark-mode a:hover {
            color: #a0cfff;
        }

        /* Breadcrumb */
        body.dark-mode .breadcrumb-item,
        body.dark-mode .breadcrumb-item a {
            color: #a0aec0 !important;
        }

        body.dark-mode .breadcrumb-item.active {
            color: #e4e4e4 !important;
        }

        /* Nav tabs */
        body.dark-mode .nav-tabs .nav-link {
            color: #a0aec0 !important;
        }

        body.dark-mode .nav-tabs .nav-link.active {
            background-color: #1f2b47 !important;
            border-color: #2d3a5f !important;
            color: #ffffff !important;
        }

        /* Input placeholder */
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #6c7a8e !important;
        }

        /* Tooltip va popover */
        body.dark-mode .tooltip-inner {
            background-color: #1f2b47 !important;
            color: #e4e4e4 !important;
        }

        /* Figure caption */
        body.dark-mode figcaption {
            color: #a0aec0 !important;
        }

        /* Progress bar label */
        body.dark-mode .progress {
            background-color: #1f2b47 !important;
        }

        /* Close button */
        body.dark-mode .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* Accordion */
        body.dark-mode .accordion-item {
            background-color: #16213e !important;
            border-color: #2d3a5f !important;
        }

        body.dark-mode .accordion-button {
            background-color: #1f2b47 !important;
            color: #e4e4e4 !important;
        }

        body.dark-mode .accordion-button:not(.collapsed) {
            background-color: #253454 !important;
            color: #ffffff !important;
        }

        body.dark-mode .accordion-body {
            background-color: #16213e !important;
            color: #e4e4e4 !important;
        }

        /* Transition for smooth mode switch */
        body, .card, .table, .form-control, .btn, .modal-content, .list-group-item {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>

<body>

    <!-- Fullscreen Exit Button (faqat admin/menejer uchun) -->
    <button id="fullscreen-exit-btn" class="btn btn-danger btn-lg shadow-lg" onclick="app.pos.toggleFullscreen()">
        <i class="fa fa-times"></i> Chiqish (ESC)
    </button>

    <!-- Kassir Bottom Toolbar -->
    <div id="cashier-toolbar">
        <div class="toolbar-left">
            <div class="toolbar-info">
                <small style="opacity: 0.7;">Kassa:</small>
                <span class="balance" id="toolbar-balance">0 so'm</span>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="toolbar-btn" onclick="app.cashierModal.open('clients')">
                <i class="fa fa-users"></i> Mijozlar
            </button>
            <button class="toolbar-btn" onclick="app.cashierModal.open('sales')">
                <i class="fa fa-receipt"></i> Savdolar
            </button>
            <button class="toolbar-btn" onclick="app.pos.quickAddExpense()">
                <i class="fa fa-wallet"></i> Xarajat
            </button>
            <button class="toolbar-btn" onclick="app.pos.showShiftInfo()">
                <i class="fa fa-clock"></i> Smena
            </button>
            <button class="toolbar-btn" onclick="app.toggleDarkMode()" id="toolbar-dark-mode-btn">
                <i class="fa fa-moon" id="toolbar-dark-icon"></i>
            </button>
            <button class="toolbar-btn btn-danger-soft" onclick="app.cashierLogout()">
                <i class="fa fa-sign-out-alt"></i> Chiqish
            </button>
        </div>
    </div>

    <!-- Kassir Section Modal -->
    <div id="cashier-section-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="cashier-modal-title" class="mb-0"><i class="fa fa-users me-2"></i>Mijozlar</h4>
                <button class="close-modal-btn" onclick="app.cashierModal.close()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="cashier-modal-body">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <div class="d-flex">
        <!-- SIDEBAR -->
        <div class="sidebar d-flex flex-column p-3 col-md-2"
            style="position:fixed; top:0; bottom:0; overflow-y:auto; width: 280px; z-index: 1000;">
            <h4 class="text-center mb-4 fw-bold">MARKET <span class="text-info">2.0</span></h4>

            <div class="mb-3 text-center p-2 bg-white bg-opacity-10 rounded">
                <small class="text-white-50 d-block">Foydalanuvchi:</small>
                <strong id="user-display-name">...</strong>
                <span id="user-display-role" class="badge bg-primary ms-1">...</span>
            </div>

            <!-- Shift Status -->
            <div id="shift-status" class="mb-3 p-2 bg-white bg-opacity-10 rounded text-center" style="display:none;">
                <small class="text-white-50 d-block">Smena holati:</small>
                <div id="shift-status-content">
                    <span class="badge bg-danger">Yopiq</span>
                    <button class="btn btn-sm btn-success mt-2 w-100" onclick="app.shifts.openShiftModal()">
                        <i class="fa fa-play"></i> Smena ochish
                    </button>
                </div>
            </div>

            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item" id="menu-pos">
                    <a class="nav-link active" onclick="app.showSection('pos')">
                        <i class="fa-solid fa-cash-register me-2"></i> Kassa (Sotuv)
                    </a>
                </li>
                <li class="nav-item" id="menu-dashboard">
                    <a class="nav-link" onclick="app.showSection('dashboard')">
                        <i class="fa-solid fa-chart-line me-2"></i> Statistika
                    </a>
                </li>
                <li class="nav-item" id="menu-products">
                    <a class="nav-link" onclick="app.showSection('products')">
                        <i class="fa-solid fa-box me-2"></i> Mahsulotlar
                    </a>
                </li>

                <li class="nav-item" id="menu-clients">
                    <a class="nav-link" onclick="app.showSection('clients')">
                        <i class="fa-solid fa-users me-2"></i> Mijozlar
                    </a>
                </li>
                <li class="nav-item" id="menu-employees">
                    <a class="nav-link" onclick="app.showSection('employees')">
                        <i class="fa-solid fa-user-tie me-2"></i> Xodimlar
                    </a>
                </li>
                <li class="nav-item" id="menu-sales">
                    <a class="nav-link" onclick="app.showSection('sales')">
                        <i class="fa-solid fa-receipt me-2"></i> Savdolar
                    </a>
                </li>
                <li class="nav-item" id="menu-expenses">
                    <a class="nav-link" onclick="app.showSection('expenses')">
                        <i class="fa-solid fa-wallet me-2"></i> Xarajatlar
                    </a>
                </li>
                <li class="nav-item" id="menu-shifts">
                    <a class="nav-link" onclick="app.showSection('shifts')">
                        <i class="fa-solid fa-clock me-2"></i> Smenalar
                    </a>
                </li>
                <li class="nav-item" id="menu-audit">
                    <a class="nav-link" onclick="app.showSection('audit')">
                        <i class="fa-solid fa-shield-halved me-2"></i> Audit
                    </a>
                </li>
            </ul>
            <hr>
            <!-- Dark Mode Toggle -->
            <button class="dark-mode-toggle mb-2" onclick="app.toggleDarkMode()" id="dark-mode-btn">
                <i class="fa fa-moon" id="dark-mode-icon"></i>
                <span id="dark-mode-text">Tungi rejim</span>
            </button>
            <button class="btn btn-outline-danger w-100" onclick="app.logout()">
                <i class="fa-solid fa-right-from-bracket me-2"></i> Chiqish
            </button>
        </div>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="col-md-2" style="width: 280px;"></div> <!-- Spacer for Sidebar -->
        <div class="flex-grow-1 bg-light p-4" style="min-height: 100vh;">

            <!-- SECTION: POS -->
            <div id="section-pos" class="main-content">
                <div class="row h-100">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="fw-bold">Sotuv Oynasi</h3>
                            <div class="d-flex gap-2 align-items-center w-50">
                                <input type="text" id="pos-search" class="form-control"
                                    placeholder="Shtrix kod yoki nom bo'yicha qidirish... (Avto-fokus)" autofocus>
                                <button class="btn btn-outline-primary btn-sm text-nowrap" onclick="app.pos.toggleFullscreen()"
                                    id="fullscreen-toggle-btn" title="To'liq ekran rejimi (F11)">
                                    <i class="fa fa-expand"></i> <span class="d-none d-lg-inline">To'liq ekran</span>
                                </button>
                            </div>
                        </div>
                        <!-- Sevimli mahsulotlar -->
                        <div id="favorite-products-section" class="mb-3 p-2 bg-warning bg-opacity-10 rounded border border-warning" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="fw-bold text-warning"><i class="fa fa-star me-1"></i> Sevimli mahsulotlar</small>
                                <button class="btn btn-sm btn-link text-muted p-0" onclick="document.getElementById('favorite-products-section').style.display='none'">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <div id="favorite-products-container" class="d-flex flex-wrap">
                                <!-- Sevimli mahsulotlar tugmalari -->
                            </div>
                        </div>
                        <div id="pos-grid" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            <!-- JS renders products here -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm" style="position:sticky; top:20px;">
                            <div class="card-header bg-white fw-bold d-flex justify-content-between">
                                <span><i class="fa-solid fa-cart-shopping"></i> Savat</span>
                                <span class="badge bg-primary" id="cart-count">0</span>
                            </div>
                            <div class="card-body p-0 d-flex flex-column">
                                <ul id="pos-cart-items" class="list-group list-group-flush flex-grow-1 overflow-auto"
                                    style="max-height: 60vh;">
                                    <!-- Cart Items -->
                                </ul>
                                <div class="p-3 bg-light border-top mt-auto">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fs-5">Jami:</span>
                                        <span class="fs-4 fw-bold text-success" id="pos-total-price">0 so'm</span>
                                    </div>
                                    <button class="btn btn-primary w-100 btn-lg shadow-sm"
                                        onclick="app.pos.checkout()">To'lov Qilish (Space)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: EMPLOYEES -->
            <div id="section-employees" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Xodimlar Boshqaruvi</h3>
                    <button class="btn btn-primary" onclick="app.modals.openAddEmployee()"><i
                            class="fa-solid fa-plus"></i> Yangi Xodim</button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Login</th>
                                    <th>To'liq Ism</th>
                                    <th>Telefon</th>
                                    <th>Manzil</th>
                                    <th>Rol</th>
                                    <th>Status</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="table-employees"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: PRODUCTS -->
            <div id="section-products" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4 gap-3">
                    <h3 class="mb-0 text-nowrap">Mahsulotlar Bazasi</h3>

                    <div class="d-flex flex-grow-1 justify-content-end gap-2">
                        <!-- Category Filter -->
                        <select id="filter-category" class="form-select w-auto" onchange="app.api.loadProducts()">
                            <option value="">Barcha Kategoriyalar</option>
                        </select>
                        <div class="input-group" style="max-width: 400px;">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fa fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0"
                                placeholder="Qidirish (Nomi yoki shtrix kod)..."
                                oninput="app.api.loadProducts(this.value)">
                        </div>

                        <button class="btn btn-outline-primary" onclick="app.modals.openCategories()">
                            <i class="fa-solid fa-list"></i> Kategoriyalar
                        </button>
                        <button class="btn btn-primary" onclick="app.handlers.toggleProductForm()">
                            <i class="fa-solid fa-plus"></i> Yangi
                        </button>
                    </div>
                </div>

                <!-- CUSTOM MODAL BACKDROP (Hidden by default) -->
                <div id="divProductForm"
                    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: start; padding-top: 50px; overflow-y: auto;">
                    <!-- MODAL CONTENT -->
                    <div class="card border-primary shadow-lg"
                        style="width: 100%; max-width: 900px; animation: popIn 0.3s ease-out; margin-bottom: 50px;">
                        <div
                            class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="formProductTitle">Yangi Mahsulot Qo'shish</h5>
                            <button type="button" class="btn-close btn-close-white"
                                onclick="app.handlers.toggleProductForm()"></button>
                        </div>
                        <div class="card-body bg-white">
                            <form id="formProduct" onsubmit="app.handlers.productSubmit(event)">
                                <input type="hidden" name="id" id="prod-id">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Nomi <span class="text-danger">*</span></label>
                                        <input type="text" name="name" id="prod-name" class="form-control" required
                                            placeholder="Masalan: Cola">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Shtrix Kod</label>
                                        <div class="input-group">
                                            <input type="text" name="barcode" id="prod-barcode" class="form-control"
                                                placeholder="Scan...">
                                            <button type="button" class="btn btn-secondary"
                                                onclick="document.getElementById('prod-barcode').value = Date.now().toString().slice(-8)">Auto</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label>Olish Narxi</label>
                                        <input type="number" name="buy_price" id="prod-buy" class="form-control"
                                            required value="0">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label>Sotish Narxi <span class="text-danger">*</span></label>
                                        <input type="number" name="sell_price" id="prod-sell" class="form-control"
                                            required value="0">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label>Qoldiq</label>
                                        <input type="number" name="stock" id="prod-stock" class="form-control" required
                                            value="0">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label>Kategoriya</label>
                                        <select name="category_id" id="prod-cat" class="form-select">
                                            <option value="">Tanlanmagan</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2"
                                        onclick="app.handlers.toggleProductForm()">Bekor qilish</button>
                                    <button type="submit" class="btn btn-success px-4">SAQLASH</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes popIn {
                        0% {
                            transform: scale(0.8);
                            opacity: 0;
                        }

                        100% {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                </style>


                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nomi</th>
                                    <th>Shtrix Kod</th>
                                    <th>Olish Narx</th>
                                    <th>Sotish Narx</th>
                                    <th>Qoldiq</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="table-products"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: CATEGORIES -->


            <!-- SECTION: DASHBOARD -->
            <div id="section-dashboard" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h3 class="fw-bold mb-0">Statistika</h3>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <input type="date" id="stats-start" class="form-control" style="width: auto;" onchange="app.stats.loadDashboard()">
                        <span class="text-muted">-</span>
                        <input type="date" id="stats-end" class="form-control" style="width: auto;" onchange="app.stats.loadDashboard()">
                        <button class="btn btn-primary" onclick="app.stats.loadDashboard()"><i class="fa fa-search"></i></button>
                        <div class="btn-group">
                            <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fa fa-file-excel"></i> Eksport
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="app.exportData('products')"><i class="fa fa-box me-2"></i>Mahsulotlar</a></li>
                                <li><a class="dropdown-item" href="#" onclick="app.exportData('sales')"><i class="fa fa-shopping-cart me-2"></i>Savdolar</a></li>
                                <li><a class="dropdown-item" href="#" onclick="app.exportData('clients')"><i class="fa fa-users me-2"></i>Mijozlar</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-info" onclick="app.stats.showCashierReport()">
                            <i class="fa fa-user-tie"></i> Kassirlar
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-primary bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Savdo (Tushum)</h6>
                                <h4 class="fw-bold text-primary mb-0" id="stat-revenue">0</h4>
                                <small class="text-muted" id="stat-sales-count">0 ta chek</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-success bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Sof Foyda</h6>
                                <h4 class="fw-bold text-success mb-0" id="stat-profit">0</h4>
                                <small class="text-muted">Xarajatlar ayrilgan</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-danger bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Xarajatlar</h6>
                                <h4 class="fw-bold text-danger mb-0" id="stat-expenses">0</h4>
                                <small class="text-muted">Do'kon xarajatlari</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-warning bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Yalpi Foyda</h6>
                                <h4 class="fw-bold text-warning mb-0" id="stat-gross">0</h4>
                                <small class="text-muted">Savdo - Olish Narxi</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-info bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Qarz To'lovlari</h6>
                                <h4 class="fw-bold text-info mb-0" id="stat-debt-payments">0</h4>
                                <small class="text-muted" id="stat-debt-count">0 ta to'lov</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card shadow-sm border-0 h-100 bg-secondary bg-opacity-10">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase mb-2 small">Umumiy Kassa</h6>
                                <h4 class="fw-bold text-secondary mb-0" id="stat-total-cash">0</h4>
                                <small class="text-muted">Savdo + To'lovlar</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kam qolgan mahsulotlar ogohlantirishi -->
                <div class="row mb-4" id="low-stock-alert" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning shadow-sm d-flex align-items-center">
                            <i class="fa fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <strong>Ombor ogohlantirishi!</strong>
                                <span id="low-stock-count">0</span> ta mahsulot kam qolgan (5 dan kam).
                                <a href="#" onclick="app.stats.showLowStock(); return false;" class="alert-link ms-2">Ko'rish</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Top Products -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header bg-white fw-bold">
                                <i class="fa fa-trophy text-warning me-2"></i> Top Mahsulotlar
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Mahsulot</th>
                                            <th class="text-end">Soni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stat-top-products"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Kam qolgan mahsulotlar -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 border-warning">
                            <div class="card-header bg-warning bg-opacity-10 fw-bold text-warning">
                                <i class="fa fa-box-open me-2"></i> Kam Qolgan Mahsulotlar
                            </div>
                            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Mahsulot</th>
                                            <th class="text-end">Qoldi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stat-low-stock"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Logs (Mini) -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <span><i class="fa fa-history text-secondary me-2"></i> So'nggi Amallar (Audit)</span>
                                <button class="btn btn-sm btn-link p-0"
                                    onclick="app.showSection('audit')">Barchasi</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="stat-audit-preview">
                                    <!-- JS Load -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kunlik/Haftalik/Oylik Hisobotlar -->
                <h5 class="fw-bold mt-4 mb-3"><i class="fa fa-chart-bar me-2"></i>Davr bo'yicha hisobotlar</h5>
                <div class="row g-3" id="reports-section">
                    <!-- Bugungi -->
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-primary text-white fw-bold">
                                <i class="fa fa-calendar-day me-2"></i>Bugun
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Savdo:</span>
                                    <span class="fw-bold" id="report-today-revenue">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Cheklar:</span>
                                    <span id="report-today-count">0 ta</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Xarajat:</span>
                                    <span class="text-danger" id="report-today-expenses">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Qarz to'lov:</span>
                                    <span class="text-info" id="report-today-payments">0 so'm</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Foyda:</span>
                                    <span class="fw-bold text-success" id="report-today-profit">0 so'm</span>
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="badge" id="report-today-change">0%</span>
                                    <small class="text-muted">kechaga nisbatan</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shu hafta -->
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-success text-white fw-bold">
                                <i class="fa fa-calendar-week me-2"></i>Shu hafta
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Savdo:</span>
                                    <span class="fw-bold" id="report-week-revenue">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Cheklar:</span>
                                    <span id="report-week-count">0 ta</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Xarajat:</span>
                                    <span class="text-danger" id="report-week-expenses">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Qarz to'lov:</span>
                                    <span class="text-info" id="report-week-payments">0 so'm</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Foyda:</span>
                                    <span class="fw-bold text-success" id="report-week-profit">0 so'm</span>
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="badge" id="report-week-change">0%</span>
                                    <small class="text-muted">o'tgan haftaga nisbatan</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shu oy -->
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-warning text-dark fw-bold">
                                <i class="fa fa-calendar-alt me-2"></i>Shu oy
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Savdo:</span>
                                    <span class="fw-bold" id="report-month-revenue">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Cheklar:</span>
                                    <span id="report-month-count">0 ta</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Xarajat:</span>
                                    <span class="text-danger" id="report-month-expenses">0 so'm</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Qarz to'lov:</span>
                                    <span class="text-info" id="report-month-payments">0 so'm</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Foyda:</span>
                                    <span class="fw-bold text-success" id="report-month-profit">0 so'm</span>
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="badge" id="report-month-change">0%</span>
                                    <small class="text-muted">o'tgan oyga nisbatan</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other sections placeholders... -->
            <div id="section-clients" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Mijozlar & Qarzdorlar</h3>
                    <button class="btn btn-outline-primary" onclick="app.api.loadAllClients()">
                        <i class="fa fa-refresh"></i> Yangilash
                    </button>
                </div>
                <!-- Qidiruv -->
                <div class="mb-3">
                    <input type="text" id="client-search-input" class="form-control"
                           placeholder="Mijoz qidirish (birinchi harf): A, B, Ali, 9..."
                           oninput="app.api.filterClients()">
                    <small class="text-muted">Ism yoki telefon raqamining birinchi harfini yozing</small>
                </div>

                <!-- Filter Debtors -->
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filter-debtors"
                            onchange="app.api.loadAllClients()">
                        <label class="form-check-label fw-bold" for="filter-debtors">Faqat qarzdorlarni
                            ko'rsatish</label>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Mijoz</th>
                                    <th>Telefon</th>
                                    <th>Balans (Qarz)</th>
                                    <th>Sana</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="table-clients"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- SECTION: SALES -->
            <div id="section-sales" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Savdolar Tarixi</h3>
                    <div class="d-flex align-items-center gap-2">
                        <input type="date" id="sales-start" class="form-control" onchange="app.api.loadSales()">
                        <span class="text-muted">-</span>
                        <input type="date" id="sales-end" class="form-control" onchange="app.api.loadSales()">
                        <button class="btn btn-outline-primary" onclick="app.api.loadSales()"><i
                                class="fa fa-refresh"></i> Yangilash</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Vaqt</th>
                                    <th>Summa</th>
                                    <th>To'lov</th>
                                    <th>Kassir</th>
                                    <th>Status</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="table-sales"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="section-expenses" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Xarajatlar (Chiqim)</h3>
                    <div class="d-flex align-items-center gap-2">
                        <input type="date" id="expenses-start" class="form-control" onchange="app.expenses.load()">
                        <span class="text-muted">-</span>
                        <input type="date" id="expenses-end" class="form-control" onchange="app.expenses.load()">
                        <button class="btn btn-outline-primary me-2" onclick="app.expenses.load()"><i
                                class="fa fa-refresh"></i> Yangilash</button>
                        <button class="btn btn-danger" onclick="app.modals.openAddExpense()"><i
                                class="fa fa-minus-circle"></i> Yangi Xarajat</button>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Sabab</th>
                                    <th>Kategoriya</th>
                                    <th>Summa</th>
                                    <th>Kim</th>
                                    <th>Vaqt</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="table-expenses">
                                <!-- JS Loads here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: SHIFTS -->
            <div id="section-shifts" class="main-content" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Smenalar Tarixi</h3>
                    <button class="btn btn-outline-primary" onclick="app.shifts.loadAll()">
                        <i class="fa fa-refresh"></i> Yangilash
                    </button>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Kassir</th>
                                    <th>Ochilgan</th>
                                    <th>Yopilgan</th>
                                    <th>Boshlang'ich</th>
                                    <th>Savdolar</th>
                                    <th>To'lovlar</th>
                                    <th>Xarajatlar</th>
                                    <th>Yakuniy</th>
                                    <th>Farq</th>
                                    <th>Holat</th>
                                    <th>Izoh</th>
                                </tr>
                            </thead>
                            <tbody id="table-shifts">
                                <!-- JS Loads here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-audit" class="main-content" style="display:none;">
                <h3 class="mb-4">Xodimlar Faoliyati va Audit</h3>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-employee-activity" data-bs-toggle="tab"
                            data-bs-target="#tab-content-activity" type="button" role="tab">
                            <i class="fa fa-users me-2"></i>Xodimlar Faoliyati
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-audit-logs" data-bs-toggle="tab"
                            data-bs-target="#tab-content-logs" type="button" role="tab">
                            <i class="fa fa-history me-2"></i>Audit Logs
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Xodimlar Faoliyati Tab -->
                    <div class="tab-pane fade show active" id="tab-content-activity" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5>Bugungi Xodimlar Faoliyati</h5>
                                <p class="text-muted mb-0">Har bir xodimning bugungi ish natijalari</p>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="date" id="activity-date" class="form-control"
                                    onchange="app.stats.loadEmployeeActivity()">
                                <button class="btn btn-primary" onclick="app.stats.loadEmployeeActivity()">
                                    <i class="fa fa-refresh"></i> Yangilash
                                </button>
                            </div>
                        </div>

                        <div class="row" id="employee-activity-cards">
                            <!-- Cards will be loaded here -->
                        </div>
                    </div>

                    <!-- Audit Logs Tab -->
                    <div class="tab-pane fade" id="tab-content-logs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5>Harakatlar Tarixi</h5>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <select id="audit-employee-filter" class="form-select"
                                    onchange="app.stats.loadAuditFull()">
                                    <option value="">Barcha xodimlar</option>
                                </select>
                                <input type="date" id="audit-start" class="form-control"
                                    onchange="app.stats.loadAuditFull()">
                                <span class="text-muted">-</span>
                                <input type="date" id="audit-end" class="form-control"
                                    onchange="app.stats.loadAuditFull()">
                                <button class="btn btn-outline-primary" onclick="app.stats.loadAuditFull()">
                                    <i class="fa fa-refresh"></i> Yangilash
                                </button>
                            </div>
                        </div>

                        <div class="card shadow-sm">
                            <div class="card-body p-0">
                                <table class="table table-hover table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vaqt</th>
                                            <th>Foydalanuvchi</th>
                                            <th>Harakat</th>
                                            <th>Tafsilot</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-audit-full">
                                        <!-- Loaded via JS -->
                                    </tbody>
                                </table>
                                <div class="p-3 text-center">
                                    <small class="text-muted">Filterga mos harakatlar ko'rsatilgan</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALS -->
    <!-- Add Employee Modal -->
    <div class="modal fade" id="modalAddEmployee" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xodim Qo'shish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Eslatma:</strong> Parol kamida 3 ta belgidan iborat bo'lishi kerak.
                    </div>
                    <form id="formAddEmployee">
                        <div class="mb-3">
                            <label>Login <span class="text-danger">*</span></label>
                            <input type="text" name="username" class="form-control" required placeholder="yangixodim">
                        </div>
                        <div class="mb-3">
                            <label>Parol <span class="text-danger">*</span></label>
                            <input type="password" name="password" class="form-control" required placeholder="******">
                        </div>
                        <div class="mb-3">
                            <label>To'liq Ism</label>
                            <input type="text" name="full_name" class="form-control" placeholder="Eshmat Toshmatov">
                        </div>
                        <div class="mb-3">
                            <label>Telefon Raqami</label>
                            <input type="text" name="phone" class="form-control" placeholder="+998901234567">
                        </div>
                        <div class="mb-3">
                            <label>Manzil / Qayerdan</label>
                            <input type="text" name="address" class="form-control" placeholder="Toshkent shahar">
                        </div>
                        <div class="mb-3">
                            <label>Pasport Seriyasi</label>
                            <input type="text" name="passport" class="form-control" placeholder="AA 1234567">
                        </div>
                        <div class="mb-3">
                            <label>Qo'shimcha Izohlar</label>
                            <textarea name="notes" class="form-control" rows="2"
                                placeholder="Ixtiyoriy ma'lumotlar..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Rol</label>
                            <select name="role" class="form-select">
                                <option value="cashier">Kassir (Sotuv)</option>
                                <option value="manager" selected>Menejer (Boshqaruv)</option>
                                <option value="admin">Admin (To'liq)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">SAQLASH</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="modalPayment" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">To'lov Turini Tanlang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h3 class="fw-bold mb-4 text-primary" id="pay-total-display">0 so'm</h3>

                    <!-- Method Selection -->
                    <div class="row g-3 mb-4" id="pay-methods">
                        <div class="col-4">
                            <button class="btn btn-outline-success w-100 py-3 fw-bold"
                                onclick="app.payment.selectMethod('cash')">
                                <i class="fa-solid fa-money-bill-1-wave d-block fs-3 mb-2"></i> Naqd
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-primary w-100 py-3 fw-bold"
                                onclick="app.payment.selectMethod('terminal')">
                                <i class="fa-solid fa-credit-card d-block fs-3 mb-2"></i> Terminal
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-warning w-100 py-3 fw-bold"
                                onclick="app.payment.selectMethod('transfer')">
                                <i class="fa-solid fa-money-bill-transfer d-block fs-3 mb-2"></i> Perevod
                            </button>
                        </div>
                    </div>
                    <!-- Nasiya (Debt) -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <button class="btn btn-outline-danger w-100 py-2 fw-bold"
                                onclick="app.payment.selectMethod('nasiya')">
                                <i class="fa-solid fa-hand-holding-dollar me-2"></i> NASIYA (Qarzga)
                            </button>
                        </div>
                    </div>

                    <!-- Cash Section -->
                    <div id="pay-cash-section" style="display:none;" class="bg-light p-3 rounded">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Mijoz Bergan Pul</label>
                            <input type="number" id="pay-received"
                                class="form-control form-control-lg text-center fw-bold" placeholder="Kiritng..."
                                oninput="app.payment.calcChange()">
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-2">
                            <span class="text-muted">Qaytim:</span>
                            <span class="fs-4 fw-bold text-success" id="pay-change">0 so'm</span>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success w-100 btn-lg" onclick="app.payment.confirm('cash')">TO'LOVNI
                                YAKUNLASH</button>
                            <button class="btn btn-link text-muted mt-2" onclick="app.payment.reset()">Orqaga</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Add Modal -->
    <div class="modal fade" id="modalAddExpense" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Yangi Xarajat (Chiqim)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="app.expenses.add(event)">
                        <div class="mb-3">
                            <label class="form-label">Sabab</label>
                            <input type="text" name="reason" class="form-control" required
                                placeholder="Masalan: Tushlik puli">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Kategoriya</label>
                            <select name="category" class="form-select">
                                <option value="Boshqa">Boshqa</option>
                                <option value="Oziq-ovqat">Oziq-ovqat</option>
                                <option value="Transport">Yo'l kira / Transport</option>
                                <option value="Kommunal">Kommunal (Svet/Gaz)</option>
                                <option value="Ijara">Ijara Haqi</option>
                                <option value="Ish haqi">Ish haqi (Avans)</option>
                                <option value="Remont">Ta'mirlash</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Summa</label>
                            <div class="input-group">
                                <input type="number" name="amount" class="form-control" required min="1" step="0.01">
                                <span class="input-group-text">so'm</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">SAQLASH</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalClientSelect" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <h5 class="modal-title">Mijozni Tanlang</h5>
                        <button class="btn btn-sm btn-outline-primary ms-3" onclick="app.clients.openModal()"><i
                                class="fa fa-refresh"></i> Yangilash</button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <input type="text" id="client-search" class="form-control mb-3" placeholder="Ism yoki telefon..."
                        oninput="app.clients.filter(this.value)">
                    <div class="list-group" id="client-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Clients will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Qarz To'lovi Modal (Yangi sodda versiya) -->
    <div class="modal fade" id="modalDebtPayment" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fa fa-hand-holding-dollar me-2"></i>Qarz To'lovi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <!-- TANLANGAN MIJOZ VA QARZ MA'LUMOTI -->
                    <div id="debt-selected-client">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="fa fa-user me-2"></i>
                                    <span id="debt-client-name"></span>
                                </h6>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Telefon:</small>
                                        <strong id="debt-client-phone"></strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">QARZ:</small>
                                        <strong id="debt-client-debt" class="text-danger fs-5"></strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TO'LOV SUMMASI -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">1. Qancha pul berayapti?</label>
                            <div class="input-group input-group-lg">
                                <input type="number" id="debt-amount" class="form-control"
                                       placeholder="Summa..."
                                       oninput="app.debt.calculateRemaining()"
                                       min="1" step="1">
                                <span class="input-group-text">so'm</span>
                            </div>
                            <button type="button" class="btn btn-link btn-sm p-0 mt-1"
                                    onclick="app.debt.setFullAmount()">
                                To'liq to'lash
                            </button>
                        </div>

                        <!-- QOLGAN QARZ -->
                        <div class="alert alert-info mb-3" id="debt-remaining-info" style="display:none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Qolgan qarz:</span>
                                <strong id="debt-remaining" class="fs-5"></strong>
                            </div>
                        </div>

                        <!-- TO'LOV USULI -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. To'lov usuli</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="debt-method" id="debt-cash"
                                       value="cash" checked>
                                <label class="btn btn-outline-success" for="debt-cash">
                                     Naqd
                                </label>
                                <input type="radio" class="btn-check" name="debt-method" id="debt-terminal"
                                       value="terminal">
                                <label class="btn btn-outline-primary" for="debt-terminal">
                                     Terminal
                                </label>
                                <input type="radio" class="btn-check" name="debt-method" id="debt-transfer"
                                       value="transfer">
                                <label class="btn btn-outline-info" for="debt-transfer">
                                     O'tkazma
                                </label>
                            </div>
                        </div>

                        <!-- IZOH (ixtiyoriy) -->
                        <div class="mb-3">
                            <label class="form-label">Izoh (ixtiyoriy)</label>
                            <input type="text" id="debt-note" class="form-control"
                                   placeholder="Masalan: Yarim qarz to'landi">
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Bekor qilish
                    </button>
                    <button type="button" class="btn btn-success btn-lg"
                            id="debt-submit-btn"
                            onclick="app.debt.submitPayment()"
                            style="display:none;">
                        <i class="fa fa-check me-2"></i>TO'LOVNI SAQLASH
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debt Confirmation Modal -->
    <div class="modal fade" id="modalDebtConfirm" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Nasiya Muddatini Belgilash</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-center">
                        <h4 class="fw-bold" id="debt-client-name">-</h4>
                        <p class="text-muted mb-0">Hozirgi Balans: <span id="debt-current-bal" class="fw-bold">0</span>
                        </p>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between px-4">
                            <span>Tolov:</span>
                            <span id="debt-new-amount" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between px-4 mt-2">
                            <span>Yangi Balans:</span>
                            <span id="debt-result-bal" class="fw-bold fs-5">0</span>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Qaytarish Sanasi</label>
                        <input type="date" id="debt-date" class="form-control form-control-lg fw-bold">
                        <small class="text-muted">Bot shu sanadan 3 kun oldin eslatishni boshlaydi.</small>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-danger btn-lg" onclick="app.payment.submitDebt()">TASDIQLASH</button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Global Error Handler for debugging
        window.onerror = function (msg, url, line, col, error) {
            alert("Xatolik (JS):\n" + msg + "\nQator: " + line);
            console.error("Global Error:", error);
            return false;
        };

        const app = {
            version: '2.1.0',

            state: {
                token: localStorage.getItem('token'),
                user: JSON.parse(localStorage.getItem('user') || '{}'),
                get role() { return this.user.role; },
                get username() { return this.user.username; },
                allClients: [], // Barcha mijozlar uchun
                cart: [],
                favoriteProducts: [] // Sevimli mahsulotlar
            },

            // Excel/CSV Eksport
            async exportData(type) {
                const startDate = document.getElementById('stats-start')?.value || '';
                const endDate = document.getElementById('stats-end')?.value || '';
                let url = `/api/export/${type}`;
                if (type === 'sales' && (startDate || endDate)) {
                    url += `?start_date=${startDate}&end_date=${endDate}`;
                }

                try {
                    const res = await this.api.fetch(url);
                    if (res.ok) {
                        const blob = await res.blob();
                        const filename = res.headers.get('Content-Disposition')?.match(/filename=(.+)/)?.[1] || `${type}.csv`;
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = filename;
                        link.click();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: `${type} eksport qilindi!`,
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: 'Eksport qilishda xatolik',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                } catch (e) {
                    console.error('Export error:', e);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Eksport qilishda xatolik',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            },

            // Sevimli mahsulotni savatga qo'shish
            addToCartFromFavorite(productId) {
                const product = this.state.favoriteProducts.find(p => p.id === productId);
                if (product) {
                    this.pos.addToCart(product.id, product.name, product.price);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: `${product.name} savatga qo'shildi`,
                        showConfirmButton: false,
                        timer: 1000
                    });
                }
            },

            // Kassir uchun modal boshqaruvchi
            cashierModal: {
                async open(sectionName) {
                    const modal = document.getElementById('cashier-section-modal');
                    const title = document.getElementById('cashier-modal-title');
                    const body = document.getElementById('cashier-modal-body');

                    body.innerHTML = '<div class="text-center p-5"><i class="fa fa-spinner fa-spin fa-2x"></i><p class="mt-2">Yuklanmoqda...</p></div>';
                    modal.classList.add('show');

                    if (sectionName === 'clients') {
                        title.innerHTML = '<i class="fa fa-users me-2"></i>Mijozlar - Qarz to\'lash';
                        await this.loadClients(body);
                    } else if (sectionName === 'sales') {
                        title.innerHTML = '<i class="fa fa-receipt me-2"></i>Bugungi savdolar';
                        await this.loadSales(body);
                    }
                },

                async loadClients(container) {
                    try {
                        const res = await app.api.fetch('/api/clients');
                        if (!res.ok) throw new Error('Yuklab bo\'lmadi');
                        const clients = await res.json();

                        // Faqat qarzli mijozlarni ajratish
                        const debtClients = clients.filter(c => c.balance < 0);
                        const otherClients = clients.filter(c => c.balance >= 0);

                        let html = `
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Mijoz qidirish..."
                                    oninput="app.cashierModal.filterClients(this.value)">
                            </div>
                        `;

                        if (debtClients.length > 0) {
                            html += `<h6 class="text-danger mb-3"><i class="fa fa-exclamation-triangle me-1"></i> Qarzli mijozlar (${debtClients.length})</h6>`;
                            html += '<div class="row g-3 mb-4" id="cashier-debt-clients">';
                            debtClients.forEach(c => {
                                html += this.clientCard(c, true);
                            });
                            html += '</div>';
                        }

                        html += `<h6 class="text-muted mb-3">Barcha mijozlar (${otherClients.length})</h6>`;
                        html += '<div class="row g-3" id="cashier-other-clients">';
                        otherClients.forEach(c => {
                            html += this.clientCard(c, false);
                        });
                        html += '</div>';

                        container.innerHTML = html;
                        app.state.modalClients = clients;
                    } catch (err) {
                        container.innerHTML = '<div class="alert alert-danger">Xatolik: ' + err.message + '</div>';
                    }
                },

                clientCard(c, isDebt) {
                    const balanceClass = c.balance < 0 ? 'text-danger' : 'text-success';
                    const balanceText = c.balance < 0 ? `${Math.abs(c.balance).toLocaleString()} so'm qarz` : `${c.balance.toLocaleString()} so'm`;
                    const cardBorder = isDebt ? 'border-danger' : '';

                    return `
                        <div class="col-md-4 col-lg-3 client-card-item" data-name="${c.name.toLowerCase()}" data-phone="${c.phone || ''}">
                            <div class="card h-100 ${cardBorder}">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-1">${c.name}</h6>
                                    <small class="text-muted d-block">${c.phone || '-'}</small>
                                    <div class="mt-2 ${balanceClass} fw-bold">${balanceText}</div>
                                    ${isDebt ? `
                                        <button class="btn btn-success btn-sm w-100 mt-2" onclick="app.cashierModal.close(); app.debt.openPaymentModalWithClient(${c.id})">
                                            <i class="fa fa-money-bill me-1"></i> To'lov qilish
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                },

                filterClients(query) {
                    const q = query.toLowerCase();
                    document.querySelectorAll('.client-card-item').forEach(card => {
                        const name = card.dataset.name;
                        const phone = card.dataset.phone;
                        if (name.startsWith(q) || phone.startsWith(q)) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                },

                async loadSales(container) {
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const res = await app.api.fetch(`/api/sales?start_date=${today}&end_date=${today}`);
                        if (!res.ok) throw new Error('Yuklab bo\'lmadi');
                        const sales = await res.json();

                        if (sales.length === 0) {
                            container.innerHTML = '<div class="text-center text-muted p-5"><i class="fa fa-receipt fa-3x mb-3"></i><p>Bugun savdo yo\'q</p></div>';
                            return;
                        }

                        let html = `
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Vaqt</th>
                                            <th>Summa</th>
                                            <th>To'lov</th>
                                            <th>Holat</th>
                                            <th>Amallar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        sales.forEach(s => {
                            const statusBadge = s.status === 'completed' ? '<span class="badge bg-success">Yakunlangan</span>' :
                                s.status === 'refunded' ? '<span class="badge bg-danger">Qaytarilgan</span>' : '<span class="badge bg-warning">Kutilmoqda</span>';

                            // Ko'rish va Vozvrat tugmalari
                            const viewBtn = `<button class="btn btn-sm btn-outline-info me-1" title="Batafsil" onclick="app.api.viewSaleDetails(${s.id})"><i class="fa fa-eye"></i></button>`;
                            const refundBtn = s.status === 'refunded' ? '' : `<button class="btn btn-sm btn-outline-danger" title="Vozvrat qilish" onclick="app.api.refundSale(${s.id})"><i class="fa-solid fa-rotate-left"></i></button>`;

                            html += `
                                <tr>
                                    <td>#${s.id}</td>
                                    <td>${s.created_at}</td>
                                    <td class="fw-bold">${s.total_amount.toLocaleString()} so'm</td>
                                    <td><span class="badge bg-info">${s.payment_method}</span></td>
                                    <td>${statusBadge}</td>
                                    <td>${viewBtn}${refundBtn}</td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table></div>';

                        // Umumiy summa
                        const total = sales.filter(s => s.status === 'completed').reduce((a, s) => a + s.total_amount, 0);
                        html += `<div class="alert alert-success mt-3"><strong>Bugungi savdo:</strong> ${total.toLocaleString()} so'm</div>`;

                        container.innerHTML = html;
                    } catch (err) {
                        container.innerHTML = '<div class="alert alert-danger">Xatolik: ' + err.message + '</div>';
                    }
                },

                close() {
                    const modal = document.getElementById('cashier-section-modal');
                    modal.classList.remove('show');
                }
            },

            handlers: {
                toggleProductForm: function () {
                    const div = document.getElementById('divProductForm');
                    if (div.style.display === 'none') {
                        div.style.display = 'flex'; // FLEX for centering
                        // Reset form only if adding new
                        if (document.getElementById('formProductTitle').innerText !== "Mahsulotni Tahrirlash") {
                            document.getElementById('formProduct').reset();
                            document.getElementById('prod-id').value = '';
                        }
                    } else {
                        div.style.display = 'none';
                        // Reset title back to default when closing
                        document.getElementById('formProductTitle').innerText = "Yangi Mahsulot Qo'shish";
                    }
                },

                async productSubmit(event) {
                    event.preventDefault();
                    console.log("Inline Product Submit Triggered!");

                    const form = event.target;
                    const btn = form.querySelector('button[type="submit"]');
                    const originalText = "SAQLASH";

                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saqlanmoqda...';
                    btn.disabled = true;

                    try {
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData);
                        console.log("Form Data:", data);
                        await app.api.saveProduct(data);
                    } catch (err) {
                        console.error("Submit Error:", err);
                        Swal.fire("Xatolik", "Tizim xatosi: " + err.message, "error");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            },

            init: async function () {
                if (!this.state.token) {
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('user-display-name').textContent = this.state.username;
                document.getElementById('user-display-role').textContent = this.state.role.toUpperCase();

                // Body ga rol classini qo'shish (CSS uchun)
                document.body.classList.add('role-' + this.state.role);

                this.setupMenu();
                // Load global data
                await this.categories.load();

                // Kassir uchun: avtomatik smena ochish oynasini ko'rsatish
                const isCashier = this.state.role === 'cashier';
                await this.shifts.checkCurrentShift(isCashier);

                // Default to POS or last used (kassir uchun doim POS)
                const defaultSection = isCashier ? 'pos' : (localStorage.getItem('last_section') || 'pos');
                this.showSection(defaultSection);
                this.setupEventListeners();

                // Kassir uchun: toolbar balansni yangilash
                if (isCashier && this.shifts.currentShift) {
                    this.pos.updateToolbarBalance();
                }

                // Admin/Menejer uchun: kam qolgan mahsulotlar ogohlantirishi
                if (['admin', 'manager'].includes(this.state.role)) {
                    this.checkLowStockAlert();
                }

                // Dark mode ni yuklash
                this.initDarkMode();
            },

            // Dark mode ni boshlash
            initDarkMode() {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    this.updateDarkModeButton(true);
                }
            },

            // Dark mode tugmasini yangilash
            updateDarkModeButton(isDark) {
                // Sidebar tugmasi
                const icon = document.getElementById('dark-mode-icon');
                const text = document.getElementById('dark-mode-text');
                if (icon) {
                    icon.className = isDark ? 'fa fa-sun' : 'fa fa-moon';
                }
                if (text) {
                    text.textContent = isDark ? 'Kunduzgi rejim' : 'Tungi rejim';
                }
                // Toolbar tugmasi (kassir uchun)
                const toolbarIcon = document.getElementById('toolbar-dark-icon');
                if (toolbarIcon) {
                    toolbarIcon.className = isDark ? 'fa fa-sun' : 'fa fa-moon';
                }
            },

            // Dark mode ni almashtirish
            toggleDarkMode() {
                const body = document.body;
                const isDark = body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDark);
                this.updateDarkModeButton(isDark);

                // Animatsiya effekti
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: isDark ? 'success' : 'info',
                    title: isDark ? 'Tungi rejim yoqildi' : 'Kunduzgi rejim yoqildi',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
            },

            // Kam qolgan mahsulotlar ogohlantirishi (login qilganda)
            async checkLowStockAlert() {
                try {
                    const res = await this.api.fetch('/api/low-stock-products?threshold=5');
                    if (res.ok) {
                        const products = await res.json();
                        this.state.lowStockProducts = products;

                        if (products.length > 0) {
                            // Kritik (0 qolgan) va kam qolgan (1-5)
                            const critical = products.filter(p => p.stock === 0);
                            const low = products.filter(p => p.stock > 0);

                            let html = '';
                            if (critical.length > 0) {
                                html += `<div class="alert alert-danger text-start mb-2"><strong><i class="fa fa-times-circle me-1"></i> Tugagan (${critical.length}):</strong><br>`;
                                html += critical.slice(0, 5).map(p => p.name).join(', ');
                                if (critical.length > 5) html += ` va yana ${critical.length - 5} ta...`;
                                html += '</div>';
                            }
                            if (low.length > 0) {
                                html += `<div class="alert alert-warning text-start"><strong><i class="fa fa-exclamation-triangle me-1"></i> Kam qolgan (${low.length}):</strong><br>`;
                                html += low.slice(0, 5).map(p => `${p.name} (${p.stock})`).join(', ');
                                if (low.length > 5) html += ` va yana ${low.length - 5} ta...`;
                                html += '</div>';
                            }

                            Swal.fire({
                                title: '<i class="fa fa-box-open text-warning me-2"></i> Ombor holati',
                                html: html,
                                icon: null,
                                confirmButtonText: 'Tushundim',
                                showCancelButton: true,
                                cancelButtonText: 'Batafsil ko\'rish'
                            }).then((result) => {
                                if (result.dismiss === Swal.DismissReason.cancel) {
                                    this.stats.showLowStock();
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error("Low stock check error:", e);
                }
            },

            setupMenu: function () {
                const role = this.state.role;
                const els = {
                    pos: document.getElementById('menu-pos'),
                    dash: document.getElementById('menu-dashboard'),
                    prod: document.getElementById('menu-products'),
                    client: document.getElementById('menu-clients'),
                    emp: document.getElementById('menu-employees'),
                    sales: document.getElementById('menu-sales'),
                    exp: document.getElementById('menu-expenses'),
                    shifts: document.getElementById('menu-shifts'),
                    audit: document.getElementById('menu-audit')
                };

                // Default hide all specific ones, show common
                Object.values(els).forEach(el => { if (el) el.style.display = 'none'; });
                if (els.pos) els.pos.style.display = 'block';

                if (role === 'admin') {
                    Object.values(els).forEach(el => { if (el) el.style.display = 'block'; });
                } else if (role === 'manager') {
                    if (els.prod) els.prod.style.display = 'block';
                    if (els.client) els.client.style.display = 'block';
                    if (els.emp) els.emp.style.display = 'block';
                    if (els.sales) els.sales.style.display = 'block';
                    if (els.exp) els.exp.style.display = 'block';
                    if (els.shifts) els.shifts.style.display = 'block';
                } else if (role === 'cashier') {
                    if (els.client) els.client.style.display = 'block';
                    if (els.sales) els.sales.style.display = 'block';
                    if (els.exp) els.exp.style.display = 'block';
                    if (els.shifts) els.shifts.style.display = 'block';
                }
            },

            showSection: function (id) {
                // Hide all
                document.querySelectorAll('.main-content').forEach(el => el.style.display = 'none');
                // Show target
                const target = document.getElementById('section-' + id);
                if (target) {
                    target.style.display = 'block';
                    localStorage.setItem('last_section', id);

                    // Highlight Menu
                    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                    const menu = document.getElementById('menu-' + id);
                    if (menu) menu.querySelector('a').classList.add('active');

                    // Load Data
                    if (id === 'pos') {
                        this.api.loadPosProducts();
                        this.api.loadFavoriteProducts();
                    }
                    if (id === 'employees') this.api.loadEmployees();
                    if (id === 'products') this.api.loadProducts();
                    if (id === 'sales') this.api.loadSales();
                    if (id === 'expenses') this.expenses.load();
                    if (id === 'shifts') this.shifts.loadAll();
                    if (id === 'dashboard') this.stats.loadDashboard();
                    if (id === 'audit') {
                        this.stats.loadEmployeeActivity();
                        this.stats.loadEmployeeFilterDropdown();
                        this.stats.loadAuditFull();
                    }
                    if (id === 'clients') this.api.loadAllClients();
                } else {
                    console.error("Section not found:", id);
                }
            },

            logout: async function () {
                const result = await Swal.fire({
                    title: 'Tizimdan chiqasizmi?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ha, chiqish',
                    cancelButtonText: 'Yo\'q'
                });
                if (result.isConfirmed) {
                    localStorage.clear();
                    window.location.href = '/login';
                }
            },

            // Kassir uchun maxsus chiqish - smena yopishni taklif qiladi
            cashierLogout: async function () {
                const shift = this.shifts.currentShift;

                if (shift) {
                    // Smena ochiq - avval yopishni so'rash
                    const result = await Swal.fire({
                        title: 'Smena hali ochiq!',
                        html: `
                            <p>Chiqishdan oldin smenani yopishingiz kerak.</p>
                            <div class="alert alert-info text-start">
                                <strong>Kutilayotgan balans:</strong> ${shift.expected_balance.toLocaleString()} so'm
                            </div>
                        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: '<i class="fa fa-stop me-1"></i> Smenani yopish',
                        cancelButtonText: 'Bekor qilish',
                        confirmButtonColor: '#dc3545'
                    });

                    if (result.isConfirmed) {
                        await this.shifts.closeShiftModal();
                    }
                } else {
                    // Smena yopiq - oddiy logout
                    await this.logout();
                }
            },

            api: {
                async fetch(url, options = {}) {
                    options.headers = { ...options.headers, 'Authorization': 'Bearer ' + app.state.token };
                    const res = await fetch(url, options);
                    if (res.status === 401) return app.logout();
                    return res;
                },

                async loadSales() {
                    let url = '/api/sales';
                    const s = document.getElementById('sales-start');
                    const e = document.getElementById('sales-end');

                    if (s && !s.value) s.valueAsDate = new Date();
                    if (e && !e.value) e.valueAsDate = new Date(); // Default today

                    if (s && e && s.value && e.value) {
                        url += `?start_date=${s.value}&end_date=${e.value}`;
                    }

                    const res = await this.fetch(url);
                    if (res.ok) {
                        const sales = await res.json();
                        const tbody = document.getElementById('table-sales');
                        if (sales.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Savdolar yo\'q</td></tr>';
                        else tbody.innerHTML = sales.map(s => {
                            let statusBadge = s.status === 'refunded' ? '<span class="badge bg-danger">Vozvrat</span>' : '<span class="badge bg-success">OK</span>';

                            // Ko'rish va Vozvrat tugmalari
                            let viewBtn = `<button class="btn btn-sm btn-outline-info me-1" title="Batafsil" onclick="app.api.viewSaleDetails(${s.id})"><i class="fa fa-eye"></i></button>`;
                            let refundBtn = s.status === 'refunded' ? '' : `<button class="btn btn-sm btn-outline-danger" title="Vozvrat qilish" onclick="app.api.refundSale(${s.id})"><i class="fa-solid fa-rotate-left"></i></button>`;

                            // Format Payment Method
                            let pMethod = s.payment_method.toLowerCase();
                            let pDisplay = s.payment_method;
                            if (pMethod === 'cash') pDisplay = '<span class="text-success fw-bold"><i class="fa-solid fa-money-bill-1-wave"></i> Naqd</span>';
                            else if (pMethod === 'terminal' || pMethod === 'card') pDisplay = '<span class="text-primary fw-bold"><i class="fa-solid fa-credit-card"></i> Terminal</span>';
                            else if (pMethod === 'transfer') pDisplay = '<span class="text-warning fw-bold"><i class="fa-solid fa-money-bill-transfer"></i> Perevod</span>';
                            else if (pMethod === 'nasiya') pDisplay = '<span class="text-danger fw-bold"><i class="fa-solid fa-hand-holding-dollar"></i> Nasiya</span>';

                            return `
                             <tr>
                                 <td>${s.id}</td>
                                 <td>${s.created_at}</td>
                                 <td class="fw-bold">${s.total_amount.toLocaleString()} so'm</td>
                                 <td>${pDisplay}</td>
                                 <td>${s.cashier}</td>
                                 <td>${statusBadge}</td>
                                 <td>${viewBtn}${refundBtn}</td>
                             </tr>
                             `;
                        }).join('');
                    }
                },

                async viewSaleDetails(saleId) {
                    try {
                        // Kassir modalini yopish (agar ochiq bo'lsa)
                        const cashierModal = document.getElementById('cashier-section-modal');
                        const wasCashierModalOpen = cashierModal && cashierModal.classList.contains('show');

                        if (wasCashierModalOpen) {
                            app.cashierModal.close();
                        }

                        const res = await this.fetch(`/api/sales/${saleId}`);
                        if (!res.ok) throw new Error('Yuklab bo\'lmadi');
                        const sale = await res.json();

                        // Mahsulotlar jadvalini yaratish
                        const itemsTable = sale.items.map(item => `
                            <tr>
                                <td>${item.product_name}</td>
                                <td class="text-center">${item.quantity}</td>
                                <td class="text-end">${item.price.toLocaleString()} so'm</td>
                                <td class="text-end fw-bold">${item.subtotal.toLocaleString()} so'm</td>
                            </tr>
                        `).join('');

                        // To'lov usuli formatlash
                        let paymentBadge = '';
                        const pm = sale.payment_method.toLowerCase();
                        if (pm === 'cash') paymentBadge = '<span class="badge bg-success">Naqd</span>';
                        else if (pm === 'terminal' || pm === 'card') paymentBadge = '<span class="badge bg-primary">Terminal</span>';
                        else if (pm === 'transfer') paymentBadge = '<span class="badge bg-warning">Perevod</span>';
                        else if (pm === 'nasiya') paymentBadge = '<span class="badge bg-danger">Nasiya</span>';

                        const statusBadge = sale.status === 'refunded' ? '<span class="badge bg-danger">Vozvrat</span>' : '<span class="badge bg-success">OK</span>';

                        await Swal.fire({
                            title: `Savdo #${sale.id}`,
                            html: `
                                <div class="text-start">
                                    <table class="table table-sm table-borderless mb-3">
                                        <tr><th>Vaqt:</th><td>${sale.created_at}</td></tr>
                                        <tr><th>Kassir:</th><td>${sale.cashier}</td></tr>
                                        <tr><th>Mijoz:</th><td>${sale.client || '-'}</td></tr>
                                        <tr><th>To'lov:</th><td>${paymentBadge}</td></tr>
                                        <tr><th>Holat:</th><td>${statusBadge}</td></tr>
                                    </table>
                                    <h6 class="mb-2">Mahsulotlar:</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Mahsulot</th>
                                                <th class="text-center">Soni</th>
                                                <th class="text-end">Narxi</th>
                                                <th class="text-end">Jami</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${itemsTable}
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr>
                                                <th colspan="3" class="text-end">UMUMIY:</th>
                                                <th class="text-end">${sale.total_amount.toLocaleString()} so'm</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `,
                            width: '600px',
                            confirmButtonText: 'Yopish'
                        });

                        // Modal yopilgandan keyin kassir modalini qayta ochish
                        if (wasCashierModalOpen) {
                            await app.cashierModal.open('sales');
                        }
                    } catch (e) {
                        console.error('View sale error:', e);
                        await Swal.fire('Xatolik', 'Savdoni yuklab bo\'lmadi', 'error');

                        // Xato bo'lsa ham, kassir modalini qayta ochish
                        const cashierModal = document.getElementById('cashier-section-modal');
                        if (cashierModal && !cashierModal.classList.contains('show')) {
                            await app.cashierModal.open('sales');
                        }
                    }
                },

                async refundSale(id) {
                    // Kassir modalini yopish (agar ochiq bo'lsa)
                    const cashierModal = document.getElementById('cashier-section-modal');
                    const wasCashierModalOpen = cashierModal && cashierModal.classList.contains('show');

                    if (wasCashierModalOpen) {
                        app.cashierModal.close();
                    }

                    const result = await Swal.fire({
                        title: 'Chekni qaytarasizmi?',
                        text: "Tovar skladga qaytadi!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Ha, qaytarish',
                        cancelButtonText: 'Bekor qilish'
                    });
                    if (!result.isConfirmed) {
                        // Agar bekor qilinsa, modalni qaytadan ochish
                        if (wasCashierModalOpen) {
                            await app.cashierModal.open('sales');
                        }
                        return;
                    }

                    const res = await this.fetch('/api/sales/' + id + '/refund', { method: 'POST' });
                    if (res.ok) {
                        await Swal.fire("Bajarildi", "Chek qaytarildi va tovar skladga qo'shildi", "success");
                        app.api.loadSales();

                        // Avtomatik yangilash
                        app.api.loadProducts(); // Mahsulotlar (sklad qaytdi)
                        app.api.loadPosProducts(); // POS mahsulotlar
                        app.api.loadFavoriteProducts(); // Sevimlilar
                        app.shifts.checkCurrentShift(); // Smena statistikasi
                        if (app.state.role === 'cashier') {
                            app.pos.updateToolbarBalance(); // Toolbar balans
                        }

                        // Kassir modali ochiq bo'lgan bo'lsa, qaytadan ochish
                        if (wasCashierModalOpen) {
                            await app.cashierModal.open('sales');
                        }
                    } else {
                        const json = await res.json();
                        await Swal.fire("Xatolik", json.detail || "Xatolik", "error");
                        // Xato bo'lsa ham, modalni qaytadan ochish
                        if (wasCashierModalOpen) {
                            await app.cashierModal.open('sales');
                        }
                    }
                },

                async loadEmployees() {
                    try {
                        const res = await this.fetch('/api/employees');
                        if (res.ok) {
                            const users = await res.json();
                            const tbody = document.getElementById('table-employees');
                            if (users.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Xodimlar topilmadi.</td></tr>';
                            else tbody.innerHTML = users.map(u => `
                        <tr>
                            <td>${u.id}</td>
                            <td><strong>${u.username}</strong></td>
                            <td>${u.full_name || '-'}</td>
                            <td>${u.phone || '-'}</td>
                            <td>${u.address || '-'}</td>
                            <td><span class="badge bg-secondary">${u.role}</span></td>
                            <td><span class="badge bg-success bg-opacity-25 text-success">Active</span></td>
                            <td>
                                <button class="btn btn-sm btn-warning text-white me-1" onclick='app.api.editEmployee(${JSON.stringify(u)})'><i class="fa fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="app.api.deleteEmployee(${u.id})"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                        } else {
                            Swal.fire("Xatolik", "Xodimlarni yuklab bo'lmadi", "error");
                        }
                    } catch (e) { console.error(e); }
                },

                async addEmployee(data) {
                    const res = await this.fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!res.ok) {
                        const json = await res.json();
                        throw new Error(json.detail || "Xatolik: " + res.status);
                    }
                    return await res.json();
                },

                async editEmployee(user) {
                    const { value: formValues } = await Swal.fire({
                        title: 'Xodim ma\'lumotlarini o\'zgartirish',
                        html: `
                            <div class="mb-3">
                                <label class="form-label">Foydalanuvchi nomi (login)</label>
                                <input id="edit-username" class="form-control" value="${user.username}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Yangi parol (o'zgartirmoqchi bo'lsangiz)</label>
                                <input id="edit-password" type="password" class="form-control" placeholder="Bo'sh qoldiring agar o'zgartirmasangiz">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">To'liq Ism</label>
                                <input id="edit-fullname" class="form-control" value="${user.full_name || ''}" placeholder="Eshmat Toshmatov">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telefon Raqami</label>
                                <input id="edit-phone" class="form-control" value="${user.phone || ''}" placeholder="+998901234567">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Manzil / Qayerdan</label>
                                <input id="edit-address" class="form-control" value="${user.address || ''}" placeholder="Toshkent shahar">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pasport Seriyasi</label>
                                <input id="edit-passport" class="form-control" value="${user.passport || ''}" placeholder="AA 1234567">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Qo'shimcha Izohlar</label>
                                <textarea id="edit-notes" class="form-control" rows="2" placeholder="Ixtiyoriy ma'lumotlar...">${user.notes || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rol</label>
                                <select id="edit-role" class="form-select" required>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Menejer</option>
                                    <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>Kassir</option>
                                </select>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Saqlash',
                        cancelButtonText: 'Bekor qilish',
                        width: '600px',
                        preConfirm: () => {
                            return {
                                username: document.getElementById('edit-username').value,
                                password: document.getElementById('edit-password').value,
                                full_name: document.getElementById('edit-fullname').value,
                                phone: document.getElementById('edit-phone').value,
                                address: document.getElementById('edit-address').value,
                                passport: document.getElementById('edit-passport').value,
                                notes: document.getElementById('edit-notes').value,
                                role: document.getElementById('edit-role').value
                            };
                        }
                    });

                    if (formValues) {
                        try {
                            const res = await this.fetch('/api/employees/' + user.id, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });

                            if (res.ok) {
                                Swal.fire("Muvaffaqiyatli!", "Xodim ma'lumotlari o'zgartirildi", "success");
                                app.api.loadEmployees();
                            } else {
                                const json = await res.json();
                                Swal.fire("Xatolik", json.detail || "O'zgartirib bo'lmadi", "error");
                            }
                        } catch (e) {
                            Swal.fire("Xatolik", "Server bilan bog'lanishda xatolik", "error");
                        }
                    }
                },

                async deleteEmployee(id) {
                    const result = await Swal.fire({
                        title: 'Bu xodimni o\'chirasizmi?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Ha, o\'chirish',
                        cancelButtonText: 'Bekor qilish'
                    });
                    if (!result.isConfirmed) return;
                    const res = await this.fetch('/api/employees/' + id, { method: 'DELETE' });
                    if (res.ok) {
                        Swal.fire("O'chirildi!", "", "success");
                        app.api.loadEmployees();
                    }
                    else {
                        const json = await res.json();
                        Swal.fire("Xatolik", json.detail || "O'chirib bo'lmadi", "error");
                    }
                },

                async loadProducts(search = '') {
                    const catId = document.getElementById('filter-category') ? document.getElementById('filter-category').value : '';
                    let url = '/api/products?';
                    if (search) url += `search=${search}&`;
                    if (catId) url += `category_id=${catId}`;
                    const res = await this.fetch(url);
                    if (res.ok) {
                        const prods = await res.json();
                        const tbody = document.getElementById('table-products');
                        if (prods.length === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Mahsulotlar topilmadi.</td></tr>';
                        else {
                            // Sevimlilarni yuqorida ko'rsatish
                            prods.sort((a, b) => (b.is_favorite ? 1 : 0) - (a.is_favorite ? 1 : 0));
                            tbody.innerHTML = prods.map(p => `
                                <tr class="${p.is_favorite ? 'table-warning' : ''}">
                                    <td>${p.id}</td>
                                    <td class="fw-bold">
                                        ${p.is_favorite ? '<i class="fa fa-star text-warning me-1"></i>' : ''}
                                        ${p.name}
                                    </td>
                                    <td><span class="badge bg-light text-dark border">${p.barcode || '-'}</span></td>
                                    <td>${p.buy_price}</td>
                                    <td class="text-primary fw-bold">${p.sell_price}</td>
                                    <td>${p.stock < 10 ? '<span class="text-danger fw-bold">' + p.stock + '</span>' : p.stock}</td>
                                    <td>
                                        <button class="btn btn-sm ${p.is_favorite ? 'btn-warning' : 'btn-outline-warning'} me-1"
                                            onclick="app.api.toggleFavorite(${p.id})" title="Sevimli">
                                            <i class="fa fa-star"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info text-white me-1" onclick="app.api.editProduct(${p.id})"><i class="fa fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="app.api.deleteProduct(${p.id})"><i class="fa fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                },

                async toggleFavorite(productId) {
                    try {
                        const res = await this.fetch(`/api/products/${productId}/favorite`, { method: 'POST' });
                        if (res.ok) {
                            const data = await res.json();
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: data.is_favorite ? 'Sevimliga qo\'shildi ' : 'Sevimlilardan olib tashlandi',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            this.loadProducts();
                            // POS uchun ham yangilash
                            this.loadFavoriteProducts();
                        }
                    } catch (e) {
                        console.error('Toggle favorite error:', e);
                    }
                },

                async loadFavoriteProducts() {
                    try {
                        const res = await this.fetch('/api/products/favorites');
                        if (res.ok) {
                            const products = await res.json();
                            app.state.favoriteProducts = products;
                            this.renderFavoriteProducts();
                        }
                    } catch (e) {
                        console.error('Load favorites error:', e);
                    }
                },

                renderFavoriteProducts() {
                    const section = document.getElementById('favorite-products-section');
                    const container = document.getElementById('favorite-products-container');
                    if (!container || !section) return;

                    const products = app.state.favoriteProducts || [];
                    if (products.length === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    section.style.display = 'block';
                    container.innerHTML = products.map(p => `
                        <button class="btn btn-outline-primary btn-sm m-1"
                            onclick="app.addToCartFromFavorite(${p.id})"
                            ${p.stock <= 0 ? 'disabled' : ''}>
                            ${p.name}
                            <span class="badge bg-primary ms-1">${p.price.toLocaleString()}</span>
                            ${p.stock <= 5 ? '<span class="badge bg-danger ms-1">' + p.stock + '</span>' : ''}
                        </button>
                    `).join('');
                },

                async saveProduct(data) {
                    console.log("Saving product...", data);
                    try {
                        const id = data.id;
                        const url = id ? `/api/products/${id}` : '/api/products';
                        const method = id ? 'PUT' : 'POST';

                        // Convert types
                        const payload = {
                            name: data.name,
                            barcode: data.barcode || "",
                            buy_price: parseFloat(data.buy_price) || 0,
                            sell_price: parseFloat(data.sell_price) || 0,
                            stock: parseInt(data.stock) || 0,
                            unit: 'dona',
                            category_id: (data.category_id && data.category_id !== "") ? parseInt(data.category_id) : null
                        };

                        const res = await this.fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            document.getElementById('divProductForm').style.display = 'none';
                            Swal.fire("Saqlandi", "", "success");
                            app.api.loadProducts();
                        } else {
                            const json = await res.json();
                            Swal.fire("Xatolik", json.detail || "Server xatosi", "error");
                            throw new Error(json.detail); // Re-throw to stop button spinner in event listener
                        }
                    } catch (e) {
                        // Allow the caller to handle specific logging if needed, or just let Swal handle it above.
                        // Actually, let's re-throw so the caller knows it failed.
                        throw e;
                    }
                },

                async deleteProduct(id) {
                    const result = await Swal.fire({
                        title: 'Mahsulotni o\'chirasizmi?',
                        text: "Qayta tiklab bo'lmaydi!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'O\'chirish',
                        cancelButtonText: 'Bekor qilish'
                    });

                    if (!result.isConfirmed) return;

                    const res = await this.fetch(`/api/products/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        Swal.fire("O'chirildi!", "", "success");
                        app.api.loadProducts();
                    } else {
                        Swal.fire("Xatolik", "O'chirib bo'lmadi", "error");
                    }
                },

                async editProduct(id) {
                    const res = await this.fetch('/api/products');
                    const prods = await res.json();
                    const p = prods.find(x => x.id == id);
                    if (p) {
                        document.getElementById('prod-id').value = p.id;
                        document.getElementById('prod-name').value = p.name;
                        document.getElementById('prod-barcode').value = p.barcode || '';
                        document.getElementById('prod-buy').value = p.buy_price;
                        document.getElementById('prod-sell').value = p.sell_price;
                        document.getElementById('prod-stock').value = p.stock;
                        document.getElementById('prod-cat').value = p.category_id || '';
                        document.getElementById('formProductTitle').innerText = "Mahsulotni Tahrirlash";

                        // Show the form div
                        document.getElementById('divProductForm').style.display = 'block';
                        // Scroll to form
                        document.getElementById('divProductForm').scrollIntoView({ behavior: 'smooth' });
                    }
                },

                async loadAllClients() {
                    const res = await this.fetch('/api/clients');
                    if (res.ok) {
                        let clients = await res.json();

                        // Barcha mijozlarni saqlash
                        app.state.allClients = clients;

                        // Qidiruv inputini tozalash
                        const searchInput = document.getElementById('client-search-input');
                        if (searchInput) searchInput.value = '';

                        // Render qilish
                        this.renderClients(clients);
                    } else {
                        Swal.fire("Xatolik", "Mijozlarni yuklab bo'lmadi", "error");
                    }
                },

                renderClients(clients) {
                    // Filter if checkbox is checked
                    const onlyDebtors = document.getElementById('filter-debtors').checked;
                    if (onlyDebtors) {
                        clients = clients.filter(c => c.balance < 0);
                    }

                    const tbody = document.getElementById('table-clients');
                        const userRole = app.state.role; // Admin, Manager, yoki Cashier

                        if (clients.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ma\'lumotlar yo\'q.</td></tr>';
                        else tbody.innerHTML = clients.map(c => {
                            // Negative balance means DEBT
                            let balanceDisplay = c.balance < 0
                                ? `<span class="text-danger fw-bold">${c.balance} so'm (Qarz)</span>`
                                : `<span class="text-success fw-bold">+${c.balance} so'm</span>`;

                            // Tugmalar - role-based
                            let actionButtons = '';

                            // Qarz to'lovi tugmasi - Faqat qarzdor mijozlar uchun
                            if (c.balance < 0) {
                                actionButtons += `<button class="btn btn-sm btn-success me-1"
                                    onclick='app.debt.openPaymentModalWithClient(${c.id})'
                                    title="Qarz to'lovi">
                                    <i class="fa fa-money-bill"></i> To'lov
                                </button>`;
                            }

                            // Qarz qo'shish - Faqat Admin va Menejer
                            if (userRole === 'admin' || userRole === 'manager') {
                                actionButtons += `<button class="btn btn-sm btn-warning text-white me-1"
                                    onclick='app.clients.addDebt(${JSON.stringify(c)})'
                                    title="Qarz qo'shish">
                                    <i class="fa fa-plus-circle"></i> Qarz
                                </button>`;
                            }

                            // To'lovlar tarixini ko'rish - Hamma uchun
                            actionButtons += `<button class="btn btn-sm btn-info text-white me-1"
                                onclick="app.api.viewPaymentHistory(${c.id}, '${c.name}')"
                                title="To'lovlar tarixi">
                                <i class="fa fa-history"></i> Tarix
                            </button>`;

                            // Mijozni tahrirlash/o'chirish - Faqat Admin va Menejer
                            if (userRole === 'admin' || userRole === 'manager') {
                                actionButtons += `<button class="btn btn-sm btn-outline-primary me-1"
                                    onclick='app.clients.edit(${JSON.stringify(c)})'
                                    title="Tahrirlash">
                                    <i class="fa fa-edit"></i>
                                </button>`;

                                if (userRole === 'admin') {
                                    actionButtons += `<button class="btn btn-sm btn-outline-danger"
                                        onclick='app.clients.delete(${c.id}, "${c.name}")'
                                        title="O'chirish">
                                        <i class="fa fa-trash"></i>
                                    </button>`;
                                }
                            }

                            return `
                            <tr>
                                <td>${c.id}</td>
                                <td class="fw-bold">${c.name}</td>
                                <td>${c.phone || '-'}</td>
                                <td>${balanceDisplay}</td>
                                <td>${(c.balance < 0 && c.debt_due_date) ? '<i class="fa fa-clock text-warning"></i> ' + c.debt_due_date.split('T')[0] : '-'}</td>
                                <td style="white-space: nowrap;">
                                    ${actionButtons}
                                </td>
                            </tr>
                        `}).join('');
                },

                // Mijozlarni qidirish (birinchi harf)
                filterClients() {
                    const searchTerm = document.getElementById('client-search-input').value.toLowerCase().trim();
                    let clients = app.state.allClients;

                    // Agar qidiruv bo'lsa, filter qilish (birinchi harf)
                    if (searchTerm) {
                        clients = clients.filter(c =>
                            c.name.toLowerCase().startsWith(searchTerm) ||
                            (c.phone && c.phone.startsWith(searchTerm))
                        );
                    }

                    // Render qilish
                    this.renderClients(clients);
                },

                async makePayment(client) {
                    const { value: formValues } = await Swal.fire({
                        title: `${client.name} - Qarz To'lash`,
                        html: `
                            <div class="mb-3">
                                <label class="form-label fw-bold">Joriy balans:</label>
                                <p class="fs-4 ${client.balance < 0 ? 'text-danger' : 'text-success'}">${client.balance} so'm</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">To'lov Summasi (so'm) <span class="text-danger">*</span></label>
                                <input id="payment-amount" type="number" class="form-control" placeholder="Summa" required min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">To'lov Usuli</label>
                                <select id="payment-method" class="form-select">
                                    <option value="cash">Naqd</option>
                                    <option value="terminal">Terminal</option>
                                    <option value="transfer">O'tkazma</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Izoh</label>
                                <textarea id="payment-note" class="form-control" rows="2" placeholder="Ixtiyoriy"></textarea>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'To\'lovni Qabul Qilish',
                        cancelButtonText: 'Bekor qilish',
                        width: '500px',
                        preConfirm: () => {
                            const amount = parseFloat(document.getElementById('payment-amount').value);
                            if (!amount || amount <= 0) {
                                Swal.showValidationMessage('To\'lov summasini kiriting');
                                return false;
                            }
                            return {
                                amount: amount,
                                payment_method: document.getElementById('payment-method').value,
                                note: document.getElementById('payment-note').value
                            };
                        }
                    });

                    if (formValues) {
                        try {
                            const res = await this.fetch(`/api/clients/${client.id}/payment`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });

                            if (res.ok) {
                                const result = await res.json();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Muvaffaqiyatli!',
                                    html: `To\'lov qabul qilindi<br><strong>Yangi balans: ${result.new_balance} so\'m</strong>`,
                                });
                                app.api.loadAllClients();
                            } else {
                                const json = await res.json();
                                Swal.fire("Xatolik", json.detail || "To'lovni qabul qilib bo'lmadi", "error");
                            }
                        } catch (e) {
                            Swal.fire("Xatolik", "Server bilan bog'lanishda xatolik", "error");
                        }
                    }
                },

                async viewPaymentHistory(clientId, clientName) {
                    try {
                        const res = await this.fetch(`/api/clients/${clientId}/payments`);
                        if (!res.ok) throw new Error("To'lovlar tarixini yuklab bo'lmadi");

                        const payments = await res.json();

                        if (payments.length === 0) {
                            Swal.fire("Ma'lumot", "To'lovlar tarixi bo'sh", "info");
                            return;
                        }

                        const tableRows = payments.map(p => {
                            // Manfiy summa = qarz qo'shildi (qizil), Musbat = to'lov qilindi (yashil)
                            const amountClass = p.amount < 0 ? 'text-danger' : 'text-success';
                            const amountText = p.amount < 0 ? `${Math.abs(p.amount).toLocaleString()} so'm` : `+${p.amount.toLocaleString()} so'm`;
                            const badgeClass = p.payment_method === 'qarz' ? 'bg-danger' : 'bg-primary';

                            return `
                            <tr>
                                <td>${p.created_at}</td>
                                <td class="fw-bold ${amountClass}">${amountText}</td>
                                <td><span class="badge ${badgeClass}">${p.payment_method}</span></td>
                                <td>${p.note || '-'}</td>
                                <td class="text-muted small">${p.created_by}</td>
                            </tr>
                            `;
                        }).join('');

                        // Modal ochish
                        const result = await Swal.fire({
                            title: `${clientName} - To'lovlar Tarixi`,
                            html: `
                                <div class="mb-3 d-flex gap-2 justify-content-center">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="app.api.filterPaymentHistory('all', ${clientId}, '${clientName}')">
                                         Hammasi
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="app.api.filterPaymentHistory('payments', ${clientId}, '${clientName}')">
                                         Faqat To'lovlar
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="app.api.filterPaymentHistory('debts', ${clientId}, '${clientName}')">
                                         Faqat Qarzlar
                                    </button>
                                </div>
                                <div class="table-responsive" id="payment-history-table">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Sana</th>
                                                <th>Summa</th>
                                                <th>Usul</th>
                                                <th>Izoh</th>
                                                <th>Kim qabul qildi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                            `,
                            width: '900px',
                            showConfirmButton: true,
                            confirmButtonText: 'Yopish',
                            didOpen: () => {
                                // Sahifa ochilganda, paymentsni global o'zgaruvchiga saqlash
                                window.currentPayments = payments;
                                window.currentClientName = clientName;
                                window.currentClientId = clientId;
                            }
                        });
                    } catch (e) {
                        Swal.fire("Xatolik", e.message, "error");
                    }
                },

                filterPaymentHistory(filterType, clientId, clientName) {
                    // Global o'zgaruvchidan paymentsni olish
                    let payments = window.currentPayments || [];

                    // Filtr qo'llash
                    if (filterType === 'payments') {
                        payments = payments.filter(p => p.amount > 0); // Faqat to'lovlar
                    } else if (filterType === 'debts') {
                        payments = payments.filter(p => p.amount < 0); // Faqat qarzlar
                    }
                    // 'all' uchun hech narsa qilmaymiz

                    // Jadval qatorlarini yaratish
                    const tableRows = payments.map(p => {
                        const amountClass = p.amount < 0 ? 'text-danger' : 'text-success';
                        const amountText = p.amount < 0 ? `${Math.abs(p.amount).toLocaleString()} so'm` : `+${p.amount.toLocaleString()} so'm`;
                        const badgeClass = p.payment_method === 'qarz' ? 'bg-danger' : 'bg-primary';

                        return `
                        <tr>
                            <td>${p.created_at}</td>
                            <td class="fw-bold ${amountClass}">${amountText}</td>
                            <td><span class="badge ${badgeClass}">${p.payment_method}</span></td>
                            <td>${p.note || '-'}</td>
                            <td class="text-muted small">${p.created_by}</td>
                        </tr>
                        `;
                    }).join('');

                    // Jadvalni yangilash
                    const tableDiv = document.getElementById('payment-history-table');
                    if (tableDiv) {
                        tableDiv.innerHTML = `
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Sana</th>
                                        <th>Summa</th>
                                        <th>Usul</th>
                                        <th>Izoh</th>
                                        <th>Kim qabul qildi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows || '<tr><td colspan="5" class="text-center text-muted">Ma\'lumot topilmadi</td></tr>'}
                                </tbody>
                            </table>
                        `;
                    }
                },

                async loadPosProducts() {
                    const res = await this.fetch('/api/products');
                    if (res.ok) {
                        const prods = await res.json();
                        const grid = document.getElementById('pos-grid');
                        if (prods.length === 0) {
                            grid.innerHTML = '<div class="col-12 text-center text-muted">Mahsulotlar yo\'q</div>';
                        } else {
                            grid.innerHTML = prods.map(p => `
                        <div class="col">
                            <div class="card h-100 pos-product-card p-3 text-center" 
                                 data-name="${p.name.toLowerCase()}" 
                                 data-barcode="${p.barcode || ''}" 
                                 onclick="app.pos.addToCart(${p.id}, '${p.name}', ${p.sell_price})">
                                <h5 class="fw-bold mb-1">${p.name}</h5>
                                <div class="text-primary fw-bold">${p.sell_price} so'm</div>
                                <small class="text-muted">Qoldiq: ${p.stock}</small>
                            </div>
                        </div>
                     `).join('');
                        }
                    }
                }
            },

            modals: {
                openAddEmployee: function () {
                    new bootstrap.Modal(document.getElementById('modalAddEmployee')).show();
                },
                openCategories: function () {
                    console.log("Opening Custom Categories Modal...");
                    const el = document.getElementById('divCategories');
                    if (!el) {
                        alert("Xatolik: Kategoriya oynasi topilmadi (HTML yo'q)");
                        return;
                    }

                    // Use Flexbox to display centered
                    el.style.display = 'flex';

                    // Load data
                    if (app.categories && typeof app.categories.load === 'function') {
                        app.categories.load();
                    } else {
                        console.error("app.categories.load funksiyasi topilmadi");
                    }
                },
                openAddProduct: function () {
                    // Using Toggle Logic for Custom Modal
                    app.handlers.toggleProductForm();
                },
                openAddExpense: function () {
                    new bootstrap.Modal(document.getElementById('modalAddExpense')).show();
                }
            },

            categories: {
                load: async function () {
                    try {
                        const res = await app.api.fetch('/api/categories');
                        if (!res.ok) throw new Error("Serverdan javob yo'q");

                        const list = await res.json();

                        // 1. Update Modal Table
                        const tbody = document.getElementById('table-categories-modal');
                        if (tbody) {
                            if (list.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Kategoriyalar mavjud emas</td></tr>';
                            } else {
                                tbody.innerHTML = list.map(c => `
                                        <tr>
                                            <td>${c.id}</td>
                                            <td class="fw-bold">${c.name}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" onclick="app.categories.delete(${c.id})">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('');
                            }
                        }

                        // 2. Update Product Form Dropdown AND Filter Dropdown
                        const select = document.getElementById('prod-cat');
                        const filter = document.getElementById('filter-category');

                        const options = list.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                        if (select) {
                            const current = select.value;
                            select.innerHTML = '<option value="">Tanlanmagan</option>' + options;
                            if (current && list.find(c => c.id == current)) select.value = current;
                        }

                        if (filter) {
                            const currentFilter = filter.value;
                            filter.innerHTML = '<option value="">Barcha Kategoriyalar</option>' + options;
                            if (currentFilter) filter.value = currentFilter;
                        }

                    } catch (e) {
                        console.error("Error loading categories:", e);
                    }
                },
                add: async function (e) {
                    e.preventDefault();
                    const input = document.getElementById('cat-name-input');
                    const name = input.value.trim();
                    if (!name) return;

                    const btn = e.target.querySelector('button');
                    const oldText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

                    try {
                        const res = await app.api.fetch('/api/categories', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });

                        if (res.ok) {
                            input.value = '';
                            await app.categories.load();
                            Swal.fire({
                                icon: 'success',
                                title: "Qo'shildi",
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else {
                            Swal.fire("Xatolik", "Saqlab bo'lmadi", "error");
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire("Xatolik", err.message, "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = oldText;
                    }
                },
                delete: async function (id) {
                    const result = await Swal.fire({
                        title: "O'chirilsinmi?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Ha',
                        cancelButtonText: "Yo'q"
                    });

                    if (result.isConfirmed) {
                        const res = await app.api.fetch(`/api/categories/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            app.categories.load();
                        } else {
                            Swal.fire("Xatolik", "O'chirib bo'lmadi", "error");
                        }
                    }
                }
            },



            setupEventListeners: function () {
                console.log("Setting up event listeners...");

                // Employee Form
                const formEmp = document.getElementById('formAddEmployee');
                if (formEmp) {
                    formEmp.onsubmit = async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        try {
                            await app.api.addEmployee(Object.fromEntries(formData));
                            Swal.fire("Muvaffaqiyatli!", "Yangi xodim qo'shildi", "success");
                            bootstrap.Modal.getInstance(document.getElementById('modalAddEmployee')).hide();
                            e.target.reset();
                            app.api.loadEmployees();
                        } catch (err) {
                            Swal.fire("Xatolik", err.message, "error");
                        }
                    };
                }

                // PRODUCT FORM - Handled via inline onsubmit now
                const formProd = document.getElementById('formProduct');
                if (!formProd) {
                    console.error("CRITICAL: formProduct not found in DOM!");
                }

                // POS Search
                const posSearch = document.getElementById('pos-search');
                if (posSearch) {
                    posSearch.oninput = (e) => {
                        const val = e.target.value.toLowerCase().trim();
                        let visibleCount = 0;

                        document.querySelectorAll('.pos-product-card').forEach(card => {
                            const name = card.getAttribute('data-name') || '';
                            const barcode = card.getAttribute('data-barcode') || '';
                            const col = card.closest('.col');

                            // Search logic: Name startsWith OR Barcode startsWith
                            if (name.startsWith(val) || barcode.startsWith(val)) {
                                col.style.display = 'block';
                                visibleCount++;
                            } else {
                                col.style.display = 'none';
                            }
                        });

                        // Not Found Message
                        const existingMsg = document.getElementById('pos-no-results');
                        const grid = document.getElementById('pos-grid');

                        if (visibleCount === 0) {
                            if (!existingMsg) {
                                const msg = document.createElement('div');
                                msg.id = 'pos-no-results';
                                msg.className = 'col-12 text-center text-muted py-5';
                                msg.innerHTML = '<h4><i class="fa fa-search"></i> Hech narsa topilmadi</h4><p>Boshqa nom yoki shtrix kod kiritib ko\'ring</p>';
                                grid.appendChild(msg);
                            } else {
                                existingMsg.style.display = 'block';
                            }
                        } else {
                            if (existingMsg) existingMsg.style.display = 'none';
                        }
                    };
                }

                // Hotkeys
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                        e.preventDefault();
                        app.pos.checkout();
                    }
                    // ESC tugmasi
                    if (e.code === 'Escape') {
                        // Avval modal ochiq bo'lsa, modalni yopish
                        const modal = document.getElementById('cashier-section-modal');
                        if (modal && modal.classList.contains('show')) {
                            e.preventDefault();
                            app.cashierModal.close();
                            return;
                        }

                        // Kassir-locked rejimida fullscreen dan chiqish mumkin emas
                        if (document.body.classList.contains('cashier-locked')) {
                            e.preventDefault();
                            return;
                        }

                        // Oddiy fullscreen dan chiqish
                        if (document.body.classList.contains('fullscreen-mode')) {
                            e.preventDefault();
                            app.pos.toggleFullscreen();
                        }
                    }
                    // F11 tugmasi bilan fullscreen rejimini yoqish/o'chirish
                    if (e.key === 'F11') {
                        e.preventDefault();
                        // Kassir-locked bo'lsa, F11 ham ishlamaydi
                        if (!document.body.classList.contains('cashier-locked')) {
                            app.pos.toggleFullscreen();
                        }
                    }
                });
            },

            payment: {
                method: null,
                total: 0,
                debtState: {}, // To store client info for debt

                open: function () {
                    this.total = app.state.cart.reduce((a, b) => a + (b.price * b.qty), 0);
                    if (this.total === 0) return;

                    document.getElementById('pay-total-display').innerText = this.total + " so'm";
                    document.getElementById('pay-methods').style.display = 'flex';
                    document.getElementById('pay-cash-section').style.display = 'none';
                    document.getElementById('pay-received').value = '';
                    document.getElementById('pay-change').innerText = "0 so'm";

                    new bootstrap.Modal(document.getElementById('modalPayment')).show();
                },

                selectMethod: function (method) {
                    this.method = method;
                    if (method === 'cash') {
                        document.getElementById('pay-methods').style.display = 'none';
                        document.getElementById('pay-cash-section').style.display = 'block';
                        document.getElementById('pay-received').focus();
                    } else if (method === 'nasiya') {
                        // Open Client Selection Modal
                        app.clients.openModal();
                    } else {
                        this.confirm(method);
                    }
                },

                reset: function () {
                    document.getElementById('pay-methods').style.display = 'flex';
                    document.getElementById('pay-cash-section').style.display = 'none';
                },

                calcChange: function () {
                    const received = parseFloat(document.getElementById('pay-received').value) || 0;
                    const change = received - this.total;
                    document.getElementById('pay-change').innerText = change + " so'm";
                    if (change < 0) {
                        document.getElementById('pay-change').className = "fs-4 fw-bold text-danger";
                    } else {
                        document.getElementById('pay-change').className = "fs-4 fw-bold text-success";
                    }
                },

                confirm: async function (method, clientId = null, dueDate = null) {
                    if (method === 'cash') {
                        const received = parseFloat(document.getElementById('pay-received').value) || 0;
                        if (received < this.total) {
                            Swal.fire("Diqqat", "Mablag' yetarli emas!", "warning");
                            return;
                        }
                    }

                    const data = {
                        items: app.state.cart.map(i => ({ product_id: i.id, quantity: i.qty, price: i.price })),
                        payment_method: method,
                        client_id: clientId,
                        due_date: dueDate
                    };

                    try {
                        const res = await app.api.fetch('/api/sell', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            const json = await res.json();
                            bootstrap.Modal.getInstance(document.getElementById('modalPayment')).hide();
                            if (document.getElementById('modalClientSelect')) {
                                try { bootstrap.Modal.getInstance(document.getElementById('modalClientSelect')).hide(); } catch (e) { }
                            }
                            if (document.getElementById('modalDebtConfirm')) {
                                try { bootstrap.Modal.getInstance(document.getElementById('modalDebtConfirm')).hide(); } catch (e) { }
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Sotuv Muvaffaqiyatli!',
                                text: 'Chek ID: ' + json.sale_id,
                                timer: 2000,
                                showConfirmButton: false
                            });
                            app.state.cart = [];
                            app.pos.renderCart();

                            // Avtomatik yangilash
                            app.api.loadPosProducts(); // Sklad yangilandi
                            app.api.loadFavoriteProducts(); // Sevimlilar (sklad o'zgargan)
                            app.shifts.checkCurrentShift(); // Smena statistikasi
                            if (app.state.role === 'cashier') {
                                app.pos.updateToolbarBalance(); // Toolbar balans
                            }
                        } else {
                            const json = await res.json();
                            Swal.fire("Xatolik", json.detail || "Server xatosi", "error");
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire("Ulanish Xatosi", "", "error");
                    }
                },

                submitDebt: function () {
                    const date = document.getElementById('debt-date').value;
                    if (!date) {
                        alert("Iltimos sanani tanlang!");
                        return;
                    }
                    this.confirm('nasiya', this.debtState.id, date);
                }
            },

            clients: {
                list: [],
                openModal: async function () {
                    const res = await app.api.fetch('/api/clients');
                    if (res.ok) {
                        this.list = await res.json();
                        this.render(this.list);
                        new bootstrap.Modal(document.getElementById('modalClientSelect')).show();
                    } else {
                        Swal.fire("Xatolik", "Mijozlarni yuklab bo'lmadi", "error");
                    }
                },
                render: function (list) {
                    const div = document.getElementById('client-list');
                    if (list.length === 0) {
                        div.innerHTML = `
                            <div class="text-center p-4">
                                <h5 class="text-muted mb-2">Mijoz topilmadi</h5>
                                <p class="text-danger small mb-0">Agar yangi bo'lsa, iltimos Telegram bot orqali ro'yxatdan o'tsin!</p>
                            </div>
                        `;
                    }
                    else div.innerHTML = list.map(c => `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            onclick="app.clients.select(${c.id}, '${c.name}', ${c.balance})">
                            <div>
                                <div class="fw-bold">${c.name}</div>
                                <small class="text-muted">${c.phone || '-'}</small>
                            </div>
                            <span class="badge ${c.balance < 0 ? 'bg-danger' : 'bg-success'} rounded-pill">${c.balance} so'm</span>
                        </button>
                    `).join('');
                },
                filter: function (txt) {
                    const val = txt.toLowerCase();
                    // Name: startsWith, Phone: includes (more flexible for numbers)
                    const filtered = this.list.filter(c => c.name.toLowerCase().startsWith(val) || (c.phone && c.phone.includes(val)));
                    this.render(filtered);
                },
                select: function (id, name, balance) {
                    app.payment.debtState = { id, name, balance };
                    // Close Client Modal
                    bootstrap.Modal.getInstance(document.getElementById('modalClientSelect')).hide();
                    // Open Debt Confirm Modal
                    document.getElementById('debt-client-name').innerText = name;

                    document.getElementById('debt-current-bal').innerText = balance + " so'm";
                    document.getElementById('debt-current-bal').className = balance < 0 ? "fw-bold text-danger" : "fw-bold text-success";

                    document.getElementById('debt-new-amount').innerText = "-" + app.payment.total + " so'm";

                    let newBal = balance - app.payment.total;
                    document.getElementById('debt-result-bal').innerText = newBal + " so'm";
                    document.getElementById('debt-result-bal').className = newBal < 0 ? "fw-bold fs-5 text-danger" : "fw-bold fs-5 text-success";

                    // Default Date: +30 days
                    const date = new Date();
                    date.setDate(date.getDate() + 30);
                    document.getElementById('debt-date').valueAsDate = date;

                    new bootstrap.Modal(document.getElementById('modalDebtConfirm')).show();
                },

                // Yangi funksiyalar - Mijozlar bo'limidagi amallar uchun

                // Mijozga qarz qo'shish (Admin/Menejer uchun)
                addDebt: async function(client) {
                    const { value: formValues } = await Swal.fire({
                        title: `${client.name} - Qarz Qo'shish`,
                        html: `
                            <div class="alert alert-warning">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <strong>Diqqat:</strong> Bu mijozga qarz qo'shadi (balansni kamaytiradi)
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Joriy balans:</label>
                                <p class="fs-4 ${client.balance < 0 ? 'text-danger' : 'text-success'}">${client.balance.toLocaleString()} so'm</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Qarz Summasi (so'm) <span class="text-danger">*</span></label>
                                <input id="debt-amount-input" type="number" class="form-control" placeholder="Summa" required min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Qarz Muddati</label>
                                <input id="debt-due-date" type="date" class="form-control" value="${this.getDefaultDueDate()}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sabab/Izoh</label>
                                <textarea id="debt-reason" class="form-control" rows="2" placeholder="Sabab yozing..."></textarea>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Qarz Qo\'shish',
                        confirmButtonColor: '#dc3545',
                        cancelButtonText: 'Bekor qilish',
                        width: '500px',
                        preConfirm: () => {
                            const amount = parseFloat(document.getElementById('debt-amount-input').value);
                            if (!amount || amount <= 0) {
                                Swal.showValidationMessage('Qarz summasini kiriting');
                                return false;
                            }
                            return {
                                amount: amount,
                                due_date: document.getElementById('debt-due-date').value,
                                reason: document.getElementById('debt-reason').value
                            };
                        }
                    });

                    if (formValues) {
                        try {
                            const res = await app.api.fetch(`/api/clients/${client.id}/debt`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });

                            if (res.ok) {
                                const result = await res.json();
                                await Swal.fire({
                                    title: 'Muvaffaqiyat!',
                                    html: `
                                        <p>Mijozga qarz qo'shildi</p>
                                        <p><strong>Yangi balans:</strong> ${result.new_balance.toLocaleString()} so'm</p>
                                    `,
                                    icon: 'success'
                                });
                                await app.api.loadAllClients();
                            } else {
                                const error = await res.json();
                                Swal.fire('Xato', error.detail || 'Xatolik yuz berdi', 'error');
                            }
                        } catch (err) {
                            Swal.fire('Xato', err.message, 'error');
                        }
                    }
                },

                // Mijozni tahrirlash
                edit: async function(client) {
                    const { value: formValues } = await Swal.fire({
                        title: 'Mijozni Tahrirlash',
                        html: `
                            <div class="mb-3">
                                <label class="form-label">Ism <span class="text-danger">*</span></label>
                                <input id="edit-name" type="text" class="form-control" value="${client.name}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telefon</label>
                                <input id="edit-phone" type="text" class="form-control" value="${client.phone || ''}">
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Saqlash',
                        cancelButtonText: 'Bekor qilish',
                        preConfirm: () => {
                            const name = document.getElementById('edit-name').value.trim();
                            if (!name) {
                                Swal.showValidationMessage('Ism kiriting');
                                return false;
                            }
                            return {
                                name: name,
                                phone: document.getElementById('edit-phone').value.trim()
                            };
                        }
                    });

                    if (formValues) {
                        try {
                            const res = await app.api.fetch(`/api/clients/${client.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });

                            if (res.ok) {
                                await Swal.fire('Muvaffaqiyat!', 'Mijoz yangilandi', 'success');
                                await app.api.loadAllClients();
                            } else {
                                const error = await res.json();
                                Swal.fire('Xato', error.detail || 'Xatolik yuz berdi', 'error');
                            }
                        } catch (err) {
                            Swal.fire('Xato', err.message, 'error');
                        }
                    }
                },

                // Mijozni o'chirish
                delete: async function(id, name) {
                    const result = await Swal.fire({
                        title: 'Ishonchingiz komilmi?',
                        html: `<p><strong>${name}</strong> mijozni o'chirmoqchimisiz?</p><p class="text-danger">Bu amalni qaytarib bo'lmaydi!</p>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Ha, o\'chirish',
                        confirmButtonColor: '#dc3545',
                        cancelButtonText: 'Bekor qilish'
                    });

                    if (result.isConfirmed) {
                        try {
                            const res = await app.api.fetch(`/api/clients/${id}`, {
                                method: 'DELETE'
                            });

                            if (res.ok) {
                                await Swal.fire('O\'chirildi!', 'Mijoz o\'chirildi', 'success');
                                await app.api.loadAllClients();
                            } else {
                                const error = await res.json();
                                Swal.fire('Xato', error.detail || 'Xatolik yuz berdi', 'error');
                            }
                        } catch (err) {
                            Swal.fire('Xato', err.message, 'error');
                        }
                    }
                },

                // Yordamchi funksiya - standart qarz muddati (+30 kun)
                getDefaultDueDate: function() {
                    const date = new Date();
                    date.setDate(date.getDate() + 30);
                    return date.toISOString().split('T')[0];
                }
            },

            pos: {
                addToCart: function (id, name, price) {
                    const item = app.state.cart.find(i => i.id === id);
                    if (item) item.qty++;
                    else app.state.cart.push({ id, name, price, qty: 1 });
                    this.renderCart();
                },
                renderCart: function () {
                    const ul = document.getElementById('pos-cart-items');
                    let total = 0;
                    let count = 0;
                    ul.innerHTML = app.state.cart.map((item, idx) => {
                        total += item.price * item.qty;
                        count += item.qty;
                        return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            <small>${item.qty} x ${item.price} = ${item.qty * item.price}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="app.pos.removeFromCart(${idx})">&times;</button>
                    </li>
                `;
                    }).join('');
                    document.getElementById('pos-total-price').innerText = total + " so'm";
                    document.getElementById('cart-count').innerText = count;
                },
                removeFromCart: function (idx) {
                    app.state.cart.splice(idx, 1);
                    this.renderCart();
                },
                checkout: function () {
                    if (app.state.cart.length === 0) return;
                    app.payment.open();
                },
                // Kassir rejimiga kirish (chiqish tugmasisiz)
                enterCashierMode: function () {
                    const body = document.body;
                    body.classList.add('fullscreen-mode');
                    body.classList.add('cashier-locked'); // Chiqish tugmasini yashirish uchun

                    const btn = document.getElementById('fullscreen-toggle-btn');
                    if (btn) {
                        btn.style.display = 'none'; // Kassir uchun fullscreen toggle tugmasini yashirish
                    }

                    // Toolbar balansni yangilash
                    this.updateToolbarBalance();

                    // Focus qidiruvga
                    setTimeout(() => {
                        document.getElementById('pos-search')?.focus();
                    }, 100);
                },

                // Toolbar balansni yangilash
                updateToolbarBalance: function () {
                    const shift = app.shifts.currentShift;
                    const balanceEl = document.getElementById('toolbar-balance');
                    if (balanceEl && shift) {
                        balanceEl.textContent = `${shift.expected_balance.toLocaleString()} so'm`;
                    }
                },

                toggleFullscreen: function () {
                    // Kassir uchun fullscreen dan chiqishni bloklash
                    if (app.state.role === 'cashier' && document.body.classList.contains('cashier-locked')) {
                        return; // Kassir chiqolmaydi
                    }

                    const body = document.body;
                    const btn = document.getElementById('fullscreen-toggle-btn');
                    const icon = btn?.querySelector('i');
                    const text = btn?.querySelector('span');

                    if (body.classList.contains('fullscreen-mode')) {
                        // Chiqish
                        body.classList.remove('fullscreen-mode');
                        body.classList.remove('cashier-locked');
                        if (icon) icon.className = 'fa fa-expand';
                        if (text) text.textContent = "To'liq ekran";
                        if (btn) {
                            btn.classList.remove('btn-danger');
                            btn.classList.add('btn-outline-primary');
                        }
                    } else {
                        // Kirish
                        body.classList.add('fullscreen-mode');
                        if (icon) icon.className = 'fa fa-compress';
                        if (text) text.textContent = "Chiqish";
                        if (btn) {
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-danger');
                        }

                        // Toolbar balansni yangilash
                        this.updateToolbarBalance();

                        // Focus qidiruvga
                        setTimeout(() => {
                            document.getElementById('pos-search')?.focus();
                        }, 100);
                    }
                },

                // Tez xarajat qo'shish (fullscreen rejimdan)
                quickAddExpense: async function () {
                    const { value: formValues } = await Swal.fire({
                        title: ' Tez xarajat qo\'shish',
                        html: `
                            <div class="mb-3 text-start">
                                <label class="form-label">Sabab</label>
                                <input id="quick-expense-reason" type="text" class="form-control" placeholder="Masalan: Choy, Oziq-ovqat..." required>
                            </div>
                            <div class="mb-3 text-start">
                                <label class="form-label">Summa (so'm)</label>
                                <input id="quick-expense-amount" type="number" class="form-control" placeholder="0" required>
                            </div>
                            <div class="mb-3 text-start">
                                <label class="form-label">Kategoriya</label>
                                <select id="quick-expense-category" class="form-select">
                                    <option value="Boshqa">Boshqa</option>
                                    <option value="Oziq-ovqat">Oziq-ovqat</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Kommunal">Kommunal</option>
                                    <option value="Maosh">Maosh</option>
                                </select>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Qo\'shish',
                        cancelButtonText: 'Bekor',
                        preConfirm: () => {
                            const reason = document.getElementById('quick-expense-reason').value;
                            const amount = parseFloat(document.getElementById('quick-expense-amount').value);
                            const category = document.getElementById('quick-expense-category').value;

                            if (!reason || isNaN(amount) || amount <= 0) {
                                Swal.showValidationMessage('Iltimos barcha maydonlarni to\'ldiring');
                                return false;
                            }

                            return { reason, amount, category };
                        }
                    });

                    if (formValues) {
                        try {
                            const res = await app.api.fetch('/api/expenses', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });

                            if (res.ok) {
                                await app.shifts.checkCurrentShift();
                                this.updateToolbarBalance();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Xarajat qo\'shildi!',
                                    text: `${formValues.amount.toLocaleString()} so'm`,
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                            } else {
                                const error = await res.json();
                                Swal.fire('Xatolik', error.detail || 'Xarajat qo\'shib bo\'lmadi', 'error');
                            }
                        } catch (err) {
                            Swal.fire('Xatolik', 'Tizim xatosi', 'error');
                        }
                    }
                },

                // Smena ma'lumotlarini ko'rsatish (fullscreen rejimdan)
                showShiftInfo: async function () {
                    const shift = app.shifts.currentShift;
                    if (!shift) {
                        Swal.fire('Ma\'lumot', 'Ochiq smena yo\'q', 'info');
                        return;
                    }

                    await Swal.fire({
                        title: ' Smena ma\'lumotlari',
                        html: `
                            <div class="text-start">
                                <table class="table table-sm mb-0">
                                    <tr><td class="text-muted">Boshlang'ich:</td><td class="fw-bold">${shift.opening_balance.toLocaleString()} so'm</td></tr>
                                    <tr><td class="text-muted">Kutilayotgan:</td><td class="fw-bold text-success">${shift.expected_balance.toLocaleString()} so'm</td></tr>
                                    <tr class="table-light"><td colspan="2" class="fw-bold">Savdolar:</td></tr>
                                    <tr><td class="text-muted ps-3"> Naqd:</td><td>${(shift.sales_cash || 0).toLocaleString()} so'm</td></tr>
                                    <tr><td class="text-muted ps-3"> Karta:</td><td>${(shift.sales_card || 0).toLocaleString()} so'm</td></tr>
                                    <tr class="table-light"><td colspan="2" class="fw-bold">Qarz to'lovlari:</td></tr>
                                    <tr><td class="text-muted ps-3"> Naqd:</td><td>${(shift.payments_cash || 0).toLocaleString()} so'm</td></tr>
                                    <tr><td class="text-muted ps-3"> Terminal:</td><td>${(shift.payments_terminal || 0).toLocaleString()} so'm</td></tr>
                                    <tr><td class="text-muted ps-3"> O'tkazma:</td><td>${(shift.payments_transfer || 0).toLocaleString()} so'm</td></tr>
                                    <tr><td class="text-muted">Xarajatlar:</td><td class="text-danger">-${(shift.total_expenses || 0).toLocaleString()} so'm</td></tr>
                                    ${(shift.refunds_count || 0) > 0 ? `<tr><td class="text-muted"> Vozvratlar:</td><td class="text-danger">${shift.refunds_count} ta (-${(shift.refunds_total || 0).toLocaleString()} so'm)</td></tr>` : ''}
                                </table>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Smenani yopish',
                        confirmButtonColor: '#dc3545',
                        cancelButtonText: 'Yopish'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.toggleFullscreen(); // Fullscreen'dan chiqish
                            app.shifts.closeShiftModal();
                        }
                    });
                }
            },
            expenses: {
                async load() {
                    let url = '/api/expenses';
                    const s = document.getElementById('expenses-start');
                    const e = document.getElementById('expenses-end');

                    if (s && !s.value) s.valueAsDate = new Date();
                    if (e && !e.value) e.valueAsDate = new Date();

                    if (s && e && s.value && e.value) {
                        url += `?start_date=${s.value}&end_date=${e.value}`;
                    }

                    const res = await app.api.fetch(url);
                    if (res.ok) {
                        const list = await res.json();
                        const tbody = document.getElementById('table-expenses');
                        if (list.length === 0) tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-4">Xarajatlar tarixi bo\'sh</td></tr>';
                        else tbody.innerHTML = list.map(e => `
                                <tr>
                                    <td>${e.id}</td>
                                    <td class="fw-bold text-dark">${e.reason}</td>
                                    <td><span class="badge bg-secondary bg-opacity-10 text-secondary border">${e.category}</span></td>
                                    <td class="text-danger fw-bold">-${e.amount}</td>
                                    <td>${e.created_by}</td>
                                    <td>${e.created_at}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="app.expenses.delete(${e.id})">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('');
                    }
                },
                async add(e) {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.disabled = true;

                    const data = {
                        reason: e.target.reason.value,
                        amount: parseFloat(e.target.amount.value),
                        category: e.target.category.value
                    };

                    try {
                        const res = await app.api.fetch('/api/expenses', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            Swal.fire({
                                icon: "success",
                                title: "Qo'shildi",
                                showConfirmButton: false,
                                timer: 1500
                            });
                            bootstrap.Modal.getInstance(document.getElementById('modalAddExpense')).hide();
                            e.target.reset();
                            app.expenses.load();
                        } else {
                            Swal.fire("Xatolik", "Saqlab bo'lmadi", "error");
                        }
                    } catch (err) {
                        console.error(err);
                    } finally {
                        btn.disabled = false;
                    }
                },
                async delete(id) {
                    const result = await Swal.fire({
                        title: "O'chirasizmi?",
                        text: "Faqat xato kiritilgan bo'lsa o'chiring!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "O'chirish"
                    });

                    if (result.isConfirmed) {
                        const res = await app.api.fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            Swal.fire({
                                icon: "success",
                                title: "O'chirildi",
                                showConfirmButton: false,
                                timer: 1500
                            });
                            app.expenses.load();
                        } else {
                            Swal.fire("Xato", "O'chirib bo'lmadi", "error");
                        }
                    }
                }
            },
            shifts: {
                currentShift: null,

                async checkCurrentShift(showModalIfClosed = false) {
                    // Faqat kassir va menejerlar uchun
                    if (!['cashier', 'manager', 'admin'].includes(app.state.role)) {
                        return;
                    }

                    const statusDiv = document.getElementById('shift-status');
                    if (statusDiv) statusDiv.style.display = 'block';

                    try {
                        const res = await app.api.fetch('/api/shifts/current');
                        if (res.ok) {
                            const data = await res.json();
                            this.currentShift = data.shift;
                            this.updateShiftStatus();

                            // Kassir uchun: smena yopiq bo'lsa avtomatik modal ochish
                            if (showModalIfClosed && !this.currentShift && app.state.role === 'cashier') {
                                await this.showCashierWelcome();
                            }
                        }
                    } catch (err) {
                        console.error('Shift status error:', err);
                    }
                },

                async showCashierWelcome() {
                    const result = await Swal.fire({
                        title: 'Xush kelibsiz! ',
                        html: `
                            <div class="text-center mb-3">
                                <i class="fa fa-cash-register fa-3x text-primary mb-3"></i>
                                <p class="mb-0">Savdo qilish uchun avval <strong>smena ochish</strong> kerak.</p>
                            </div>
                        `,
                        icon: null,
                        showCancelButton: false,
                        confirmButtonText: '<i class="fa fa-play me-2"></i> Smena ochish',
                        confirmButtonColor: '#28a745',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });

                    if (result.isConfirmed) {
                        await this.openShiftModal(true); // true = kassir uchun maxsus rejim
                    }
                },

                updateShiftStatus() {
                    const statusContent = document.getElementById('shift-status-content');
                    if (!statusContent) return;

                    if (this.currentShift) {
                        statusContent.innerHTML = `
                            <span class="badge bg-success">Ochiq</span>
                            <div class="mt-2 small text-white-50">
                                <div>Boshlang'ich: ${this.currentShift.opening_balance.toLocaleString()} so'm</div>
                                <div>Kutilayotgan: ${this.currentShift.expected_balance.toLocaleString()} so'm</div>
                            </div>
                            <button class="btn btn-sm btn-danger mt-2 w-100" onclick="app.shifts.closeShiftModal()">
                                <i class="fa fa-stop"></i> Smena yopish
                            </button>
                        `;
                    } else {
                        statusContent.innerHTML = `
                            <span class="badge bg-danger">Yopiq</span>
                            <button class="btn btn-sm btn-success mt-2 w-100" onclick="app.shifts.openShiftModal()">
                                <i class="fa fa-play"></i> Smena ochish
                            </button>
                        `;
                    }
                },

                async openShiftModal(isCashierWelcome = false) {
                    const { value: formValues } = await Swal.fire({
                        title: isCashierWelcome ? ' Smena ochish' : 'Smena ochish',
                        html: `
                            <div class="mb-3 text-start">
                                <label class="form-label">Boshlang'ich kassadagi pul (so'm)</label>
                                <input id="shift-opening-balance" type="number" class="form-control" placeholder="Kassadagi pulni kiriting" required>
                            </div>
                            <div class="mb-3 text-start">
                                <label class="form-label">Izoh (ixtiyoriy)</label>
                                <textarea id="shift-note" class="form-control" rows="2" placeholder="Masalan: Ertalabki smena"></textarea>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: !isCashierWelcome,
                        confirmButtonText: '<i class="fa fa-play me-2"></i> Ochish',
                        cancelButtonText: 'Bekor qilish',
                        confirmButtonColor: '#28a745',
                        allowOutsideClick: !isCashierWelcome,
                        allowEscapeKey: !isCashierWelcome,
                        preConfirm: () => {
                            const opening_balance = parseFloat(document.getElementById('shift-opening-balance').value);
                            const note = document.getElementById('shift-note').value;

                            if (isNaN(opening_balance) || opening_balance < 0) {
                                Swal.showValidationMessage('Iltimos to\'g\'ri summa kiriting');
                                return false;
                            }

                            return { opening_balance, note };
                        }
                    });

                    if (formValues) {
                        await this.openShift(formValues, isCashierWelcome);
                    }
                },

                async openShift(data, isCashierWelcome = false) {
                    try {
                        const res = await app.api.fetch('/api/shifts/open', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            const result = await res.json();
                            await this.checkCurrentShift(); // Reload shift status first

                            if (isCashierWelcome && app.state.role === 'cashier') {
                                // Kassir uchun: to'g'ridan-to'g'ri savdo oynasiga va fullscreen rejimiga
                                await Swal.fire({
                                    icon: 'success',
                                    title: 'Smena ochildi! ',
                                    html: `
                                        <p>Boshlang'ich: <strong>${data.opening_balance.toLocaleString()} so'm</strong></p>
                                        <p class="text-muted small">Savdo oynasiga o'tilmoqda...</p>
                                    `,
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // POS ga o'tish va toolbar balansini yangilash
                                app.showSection('pos');
                                setTimeout(() => {
                                    app.pos.updateToolbarBalance();
                                    document.getElementById('pos-search')?.focus();
                                }, 300);
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Smena ochildi!',
                                    text: `Boshlang'ich: ${data.opening_balance.toLocaleString()} so'm`,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            }
                        } else {
                            const error = await res.json();
                            Swal.fire('Xatolik', error.detail || 'Smena ochib bo\'lmadi', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Xatolik', 'Tizim xatosi', 'error');
                    }
                },

                async closeShiftModal() {
                    if (!this.currentShift) {
                        Swal.fire('Xatolik', 'Ochiq smena topilmadi', 'error');
                        return;
                    }

                    const { value: formValues } = await Swal.fire({
                        title: 'Smena yopish',
                        html: `
                            <div class="mb-3 text-start">
                                <div class="alert alert-info">
                                    <strong>Kutilayotgan balans:</strong> ${this.currentShift.expected_balance.toLocaleString()} so'm<br>
                                    <small class="text-muted">
                                        <strong>Boshlang'ich:</strong> ${this.currentShift.opening_balance.toLocaleString()} so'm<br>
                                        <strong>Savdolar:</strong><br>
                                        &nbsp;&nbsp; Naqd: ${(this.currentShift.sales_cash || 0).toLocaleString()} so'm<br>
                                        &nbsp;&nbsp; Karta: ${(this.currentShift.sales_card || 0).toLocaleString()} so'm<br>
                                        <strong>Qarz to'lovlari:</strong><br>
                                        &nbsp;&nbsp; Naqd: ${(this.currentShift.payments_cash || 0).toLocaleString()} so'm<br>
                                        &nbsp;&nbsp; Terminal: ${(this.currentShift.payments_terminal || 0).toLocaleString()} so'm<br>
                                        &nbsp;&nbsp; O'tkazma: ${(this.currentShift.payments_transfer || 0).toLocaleString()} so'm<br>
                                        <strong>Xarajatlar:</strong> ${(this.currentShift.total_expenses || 0).toLocaleString()} so'm<br>
                                        ${(this.currentShift.refunds_count || 0) > 0 ? `<strong class="text-danger"> Vozvratlar:</strong> ${this.currentShift.refunds_count} ta (${(this.currentShift.refunds_total || 0).toLocaleString()} so'm)<br>` : ''}
                                    </small>
                                </div>
                                <label class="form-label">Haqiqiy kassadagi pul (so'm)</label>
                                <input id="shift-closing-balance" type="number" class="form-control" placeholder="Kassadagi pulni kiriting" required>
                            </div>
                            <div class="mb-3 text-start">
                                <label class="form-label">Izoh (ixtiyoriy)</label>
                                <textarea id="shift-close-note" class="form-control" rows="2" placeholder="Masalan: Hammasini sanab chiqdim"></textarea>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'Yopish',
                        cancelButtonText: 'Bekor qilish',
                        confirmButtonColor: '#dc3545',
                        preConfirm: () => {
                            const closing_balance = parseFloat(document.getElementById('shift-closing-balance').value);
                            const note = document.getElementById('shift-close-note').value;

                            if (isNaN(closing_balance) || closing_balance < 0) {
                                Swal.showValidationMessage('Iltimos to\'g\'ri summa kiriting');
                                return false;
                            }

                            return { closing_balance, note };
                        }
                    });

                    if (formValues) {
                        await this.closeShift(this.currentShift.id, formValues);
                    }
                },

                async closeShift(shiftId, data) {
                    try {
                        const res = await app.api.fetch(`/api/shifts/${shiftId}/close`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            const result = await res.json();
                            const difference = result.difference;
                            const differenceText = difference === 0
                                ? '<span class="text-success">To\'g\'ri</span>'
                                : `<span class="text-${difference > 0 ? 'success' : 'danger'}">${difference > 0 ? '+' : ''}${difference} so'm</span>`;

                            await Swal.fire({
                                icon: difference === 0 ? 'success' : 'warning',
                                title: 'Smena yopildi!',
                                html: `
                                    <div class="text-start">
                                        <p><strong>Boshlang'ich:</strong> ${result.opening_balance.toLocaleString()} so'm</p>
                                        <p><strong>Yakuniy:</strong> ${result.closing_balance.toLocaleString()} so'm</p>
                                        <p><strong>Kutilgan:</strong> ${result.expected_balance.toLocaleString()} so'm</p>
                                        <p><strong>Farq:</strong> ${differenceText}</p>
                                        <hr>
                                        <p><strong>Savdolar:</strong> ${result.total_sales.toLocaleString()} so'm</p>
                                        <p><strong>Qarz to'lovlari:</strong> ${result.total_payments.toLocaleString()} so'm</p>
                                        <p><strong>Xarajatlar:</strong> ${result.total_expenses.toLocaleString()} so'm</p>
                                        ${(result.refunds_count || 0) > 0 ? `<p class="text-danger"><strong> Vozvratlar:</strong> ${result.refunds_count} ta (${result.refunds_total.toLocaleString()} so'm)</p>` : ''}
                                    </div>
                                `,
                                confirmButtonText: 'OK'
                            });

                            this.currentShift = null;
                            this.updateShiftStatus();

                            // Kassir uchun: smena yopilgandan keyin avtomatik logout
                            if (app.state.role === 'cashier') {
                                localStorage.clear();
                                window.location.href = '/login';
                            }
                        } else {
                            const error = await res.json();
                            Swal.fire('Xatolik', error.detail || 'Smena yopib bo\'lmadi', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Xatolik', 'Tizim xatosi', 'error');
                    }
                },

                async loadAll() {
                    try {
                        const res = await app.api.fetch('/api/shifts');
                        if (res.ok) {
                            const shifts = await res.json();
                            const tbody = document.getElementById('table-shifts');

                            if (!tbody) {
                                console.error('#table-shifts not found');
                                return;
                            }

                            if (shifts.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted p-4">Smenalar tarixi bo\'sh</td></tr>';
                            } else {
                                tbody.innerHTML = shifts.map(s => `
                                    <tr>
                                        <td>${s.id}</td>
                                        <td>${s.cashier}</td>
                                        <td>${s.opened_at}</td>
                                        <td>${s.closed_at || '<span class="text-muted">Ochiq</span>'}</td>
                                        <td>${s.opening_balance.toLocaleString()}</td>
                                        <td>${s.total_sales.toLocaleString()}</td>
                                        <td>${s.total_payments.toLocaleString()}</td>
                                        <td>${s.total_expenses.toLocaleString()}</td>
                                        <td>${s.closing_balance !== null ? s.closing_balance.toLocaleString() : '-'}</td>
                                        <td>${s.difference !== undefined ? s.difference.toLocaleString() : '0'}</td>
                                        <td>
                                            <span class="badge bg-${s.status === 'open' ? 'success' : 'secondary'}">
                                                ${s.status === 'open' ? 'Ochiq' : 'Yopiq'}
                                            </span>
                                        </td>
                                        <td>${s.note || '-'}</td>
                                    </tr>
                                `).join('');
                            }
                        }
                    } catch (err) {
                        console.error('Load shifts error:', err);
                    }
                }
            },
            stats: {
                async loadDashboard() {
                    const idxS = document.getElementById('stats-start');
                    const idxE = document.getElementById('stats-end');

                    // Set defaults if empty
                    if (!idxS.value) idxS.valueAsDate = new Date();
                    if (!idxE.value) idxE.valueAsDate = new Date();

                    const start = idxS.value;
                    const end = idxE.value;

                    try {
                        const res = await app.api.fetch(`/api/stats?start_date=${start}&end_date=${end}`);
                        if (res.ok) {
                            const data = await res.json();
                            document.getElementById('stat-revenue').innerText = data.revenue.toLocaleString() + " so'm";
                            document.getElementById('stat-sales-count').innerText = data.sales_count + " ta chek";
                            document.getElementById('stat-profit').innerText = data.net_profit.toLocaleString() + " so'm";
                            document.getElementById('stat-expenses').innerText = data.expenses.toLocaleString() + " so'm";
                            document.getElementById('stat-gross').innerText = data.gross_profit.toLocaleString() + " so'm";

                            // Qarz to'lovlari
                            document.getElementById('stat-debt-payments').innerText = data.debt_payments.toLocaleString() + " so'm";
                            document.getElementById('stat-debt-count').innerText = data.debt_payments_count + " ta to'lov";

                            // Umumiy kassa (savdo + qarz to'lovlari)
                            const totalCash = data.revenue + data.debt_payments;
                            document.getElementById('stat-total-cash').innerText = totalCash.toLocaleString() + " so'm";

                            const tbody = document.getElementById('stat-top-products');
                            if (data.top_products.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted small">Sotuv yo\'q</td></tr>';
                            else tbody.innerHTML = data.top_products.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td class="text-end fw-bold">${p.qty}</td>
                                </tr>
                            `).join('');
                        }

                        const resAudit = await app.api.fetch('/api/audits');
                        if (resAudit.ok) {
                            const logs = await resAudit.json();
                            const div = document.getElementById('stat-audit-preview');
                            if (logs.length === 0) div.innerHTML = '<div class="p-3 text-muted text-center">Tarix bo\'sh</div>';
                            else div.innerHTML = logs.slice(0, 5).map(l => `
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <small class="mb-1 fw-bold text-dark">${l.action}</small>
                                        <small class="text-muted">${l.created_at.split(' ')[1]}</small>
                                    </div>
                                    <p class="mb-1 small text-muted">${l.details}</p>
                                    <small class="text-primary">${l.user}</small>
                                </div>
                            `).join('');
                        }
                        // Kam qolgan mahsulotlarni yuklash
                        await this.loadLowStock();

                        // Hisobotlarni yuklash
                        await this.loadReports();
                    } catch (e) {
                        console.error("Stats Error:", e);
                    }
                },

                // Kunlik/Haftalik/Oylik hisobotlar
                async loadReports() {
                    try {
                        const res = await app.api.fetch('/api/reports/summary');
                        if (res.ok) {
                            const data = await res.json();

                            // Bugun
                            document.getElementById('report-today-revenue').textContent = data.today.revenue.toLocaleString() + " so'm";
                            document.getElementById('report-today-count').textContent = data.today.sales_count + " ta";
                            document.getElementById('report-today-expenses').textContent = data.today.expenses.toLocaleString() + " so'm";
                            document.getElementById('report-today-payments').textContent = data.today.payments.toLocaleString() + " so'm";
                            document.getElementById('report-today-profit').textContent = data.today.profit.toLocaleString() + " so'm";
                            this.updateChangeBadge('report-today-change', data.today.change);

                            // Shu hafta
                            document.getElementById('report-week-revenue').textContent = data.this_week.revenue.toLocaleString() + " so'm";
                            document.getElementById('report-week-count').textContent = data.this_week.sales_count + " ta";
                            document.getElementById('report-week-expenses').textContent = data.this_week.expenses.toLocaleString() + " so'm";
                            document.getElementById('report-week-payments').textContent = data.this_week.payments.toLocaleString() + " so'm";
                            document.getElementById('report-week-profit').textContent = data.this_week.profit.toLocaleString() + " so'm";
                            this.updateChangeBadge('report-week-change', data.this_week.change);

                            // Shu oy
                            document.getElementById('report-month-revenue').textContent = data.this_month.revenue.toLocaleString() + " so'm";
                            document.getElementById('report-month-count').textContent = data.this_month.sales_count + " ta";
                            document.getElementById('report-month-expenses').textContent = data.this_month.expenses.toLocaleString() + " so'm";
                            document.getElementById('report-month-payments').textContent = data.this_month.payments.toLocaleString() + " so'm";
                            document.getElementById('report-month-profit').textContent = data.this_month.profit.toLocaleString() + " so'm";
                            this.updateChangeBadge('report-month-change', data.this_month.change);
                        }
                    } catch (e) {
                        console.error("Reports error:", e);
                    }
                },

                // O'zgarish badge ni yangilash
                updateChangeBadge(elementId, change) {
                    const el = document.getElementById(elementId);
                    if (!el) return;

                    const isPositive = change >= 0;
                    el.className = `badge ${isPositive ? 'bg-success' : 'bg-danger'}`;
                    el.textContent = `${isPositive ? '+' : ''}${change}%`;
                },

                // Kam qolgan mahsulotlar
                async loadLowStock() {
                    try {
                        const res = await app.api.fetch('/api/low-stock-products?threshold=5');
                        if (res.ok) {
                            const products = await res.json();
                            const tbody = document.getElementById('stat-low-stock');
                            const alertDiv = document.getElementById('low-stock-alert');
                            const countSpan = document.getElementById('low-stock-count');

                            if (products.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted small p-3"><i class="fa fa-check-circle text-success me-1"></i> Hammasi yetarli</td></tr>';
                                if (alertDiv) alertDiv.style.display = 'none';
                            } else {
                                tbody.innerHTML = products.map(p => `
                                    <tr class="${p.stock === 0 ? 'table-danger' : p.stock <= 2 ? 'table-warning' : ''}">
                                        <td>
                                            <span class="fw-bold">${p.name}</span>
                                            ${p.barcode ? `<br><small class="text-muted">${p.barcode}</small>` : ''}
                                        </td>
                                        <td class="text-end">
                                            <span class="badge ${p.stock === 0 ? 'bg-danger' : 'bg-warning'}">${p.stock} ${p.unit || 'dona'}</span>
                                        </td>
                                    </tr>
                                `).join('');

                                if (alertDiv) alertDiv.style.display = 'block';
                                if (countSpan) countSpan.textContent = products.length;
                            }

                            // Global state ga saqlash (init da tekshirish uchun)
                            app.state.lowStockProducts = products;
                        }
                    } catch (e) {
                        console.error("Low stock error:", e);
                    }
                },

                // Kam qolgan mahsulotlarni modal da ko'rsatish
                showLowStock() {
                    const products = app.state.lowStockProducts || [];
                    if (products.length === 0) {
                        Swal.fire('Ma\'lumot', 'Kam qolgan mahsulotlar yo\'q', 'info');
                        return;
                    }

                    let html = '<table class="table table-sm"><thead><tr><th>Mahsulot</th><th>Qoldi</th><th>Narxi</th></tr></thead><tbody>';
                    products.forEach(p => {
                        const rowClass = p.stock === 0 ? 'table-danger' : p.stock <= 2 ? 'table-warning' : '';
                        html += `<tr class="${rowClass}">
                            <td>${p.name}</td>
                            <td><span class="badge ${p.stock === 0 ? 'bg-danger' : 'bg-warning'}">${p.stock}</span></td>
                            <td>${p.sell_price?.toLocaleString() || 0} so'm</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';

                    Swal.fire({
                        title: '<i class="fa fa-exclamation-triangle text-warning me-2"></i> Kam Qolgan Mahsulotlar',
                        html: html,
                        width: 600,
                        confirmButtonText: 'Yopish'
                    });
                },

                // Kassirlar hisoboti
                async showCashierReport() {
                    const startDate = document.getElementById('stats-start').value;
                    const endDate = document.getElementById('stats-end').value;

                    try {
                        const res = await app.api.fetch(`/api/cashier-report?start_date=${startDate}&end_date=${endDate}`);
                        if (res.ok) {
                            const report = await res.json();

                            if (report.length === 0) {
                                Swal.fire('Ma\'lumot', 'Kassirlar topilmadi', 'info');
                                return;
                            }

                            let html = `
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Kassir</th>
                                                <th class="text-end">Savdo</th>
                                                <th class="text-end">Cheklar</th>
                                                <th class="text-end">Naqd</th>
                                                <th class="text-end">Karta</th>
                                                <th class="text-end">Nasiya</th>
                                                <th class="text-end">To'lovlar</th>
                                                <th class="text-end">Vozvrat</th>
                                                <th class="text-end">O'rtacha</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            report.forEach((c, idx) => {
                                const medal = idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : '';
                                const refundText = c.refunds_count > 0 ?
                                    `<span class="text-danger">${c.refunds_count} ta (${c.refunds_total.toLocaleString()} so'm)</span>` :
                                    '<span class="text-muted">-</span>';
                                html += `
                                    <tr>
                                        <td><strong>${medal} ${c.name}</strong><br><small class="text-muted">${c.role}</small></td>
                                        <td class="text-end fw-bold text-primary">${c.sales_total.toLocaleString()}</td>
                                        <td class="text-end">${c.sales_count}</td>
                                        <td class="text-end text-success">${c.cash_sales.toLocaleString()}</td>
                                        <td class="text-end text-info">${c.card_sales.toLocaleString()}</td>
                                        <td class="text-end text-warning">${c.nasiya_sales.toLocaleString()}</td>
                                        <td class="text-end text-secondary">${c.payments_collected.toLocaleString()}</td>
                                        <td class="text-end">${refundText}</td>
                                        <td class="text-end">${c.avg_sale.toLocaleString()}</td>
                                    </tr>
                                `;
                            });

                            html += '</tbody></table></div>';

                            Swal.fire({
                                title: '<i class="fa fa-user-tie text-info me-2"></i> Kassirlar Hisoboti',
                                html: html,
                                width: 900,
                                confirmButtonText: 'Yopish'
                            });
                        }
                    } catch (e) {
                        console.error("Cashier report error:", e);
                        Swal.fire('Xatolik', 'Hisobotni yuklashda xatolik', 'error');
                    }
                },

                async loadAuditFull() {
                    let url = '/api/audits';
                    const s = document.getElementById('audit-start');
                    const e = document.getElementById('audit-end');
                    const empFilter = document.getElementById('audit-employee-filter');

                    if (s && !s.value) s.valueAsDate = new Date();
                    if (e && !e.value) e.valueAsDate = new Date();

                    let params = [];
                    if (s && e && s.value && e.value) {
                        params.push(`start_date=${s.value}`);
                        params.push(`end_date=${e.value}`);
                    }

                    // Employee filter
                    if (empFilter && empFilter.value) {
                        params.push(`employee_id=${empFilter.value}`);
                    }

                    if (params.length > 0) {
                        url += '?' + params.join('&');
                    }

                    const res = await app.api.fetch(url);
                    if (res.ok) {
                        const logs = await res.json();
                        const tbody = document.getElementById('table-audit-full');
                        if (logs.length === 0) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Tarix bo\'sh</td></tr>';
                        else tbody.innerHTML = logs.map(l => `
                            <tr>
                                <td>${l.created_at}</td>
                                <td class="fw-bold text-primary">${l.user}</td>
                                <td><span class="badge bg-info">${l.action}</span></td>
                                <td class="text-muted small">${l.details}</td>
                            </tr>
                        `).join('');
                    }
                },

                async loadEmployeeActivity() {
                    const dateInput = document.getElementById('activity-date');
                    if (!dateInput.value) {
                        dateInput.valueAsDate = new Date();
                    }

                    let url = `/api/employee-activity?date=${dateInput.value}`;

                    const res = await app.api.fetch(url);
                    if (res.ok) {
                        const activities = await res.json();
                        const container = document.getElementById('employee-activity-cards');

                        if (activities.length === 0) {
                            container.innerHTML = '<div class="col-12"><div class="alert alert-info">Hech qanday faoliyat topilmadi</div></div>';
                            return;
                        }

                        container.innerHTML = activities.map(emp => {
                            const roleColors = {
                                'admin': 'danger',
                                'manager': 'warning',
                                'cashier': 'success'
                            };
                            const roleColor = roleColors[emp.role] || 'secondary';

                            return `
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 shadow-sm border-${roleColor}">
                                        <div class="card-header bg-${roleColor} bg-opacity-10">
                                            <h6 class="mb-0">
                                                <i class="fa fa-user me-2"></i>${emp.full_name}
                                                <span class="badge bg-${roleColor} float-end">${emp.role}</span>
                                            </h6>
                                            <small class="text-muted">@${emp.username}</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="text-muted">Savdolar:</span>
                                                    <strong class="fs-5">${emp.sales_count}</strong>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="text-muted">Jami summa:</span>
                                                    <strong class="text-success">${emp.total_revenue.toLocaleString()} so'm</strong>
                                                </div>
                                            </div>

                                            <hr>

                                            <div class="small">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span> Naqd:</span>
                                                    <span>${emp.cash_sales.toLocaleString()}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span> Karta:</span>
                                                    <span>${emp.card_sales.toLocaleString()}</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span> Nasiya:</span>
                                                    <span>${emp.credit_sales.toLocaleString()}</span>
                                                </div>
                                            </div>

                                            ${emp.last_activity ? `
                                                <hr>
                                                <div class="small text-muted">
                                                    <i class="fa fa-clock me-1"></i>
                                                    Oxirgi faoliyat: <strong>${emp.last_action}</strong>
                                                    <br>
                                                    <span class="text-muted">${emp.last_activity}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <button class="btn btn-sm btn-outline-primary w-100"
                                                onclick="app.stats.viewEmployeeDetails(${emp.employee_id}, '${dateInput.value}')">
                                                <i class="fa fa-eye me-1"></i> Tafsilotlar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                },

                async viewEmployeeDetails(employeeId, date) {
                    // Switch to audit logs tab and filter by employee
                    document.getElementById('tab-audit-logs').click();
                    document.getElementById('audit-start').value = date;
                    document.getElementById('audit-end').value = date;
                    document.getElementById('audit-employee-filter').value = employeeId;
                    await this.loadAuditFull();
                },

                async loadEmployeeFilterDropdown() {
                    const res = await app.api.fetch('/api/employees');
                    if (res.ok) {
                        const employees = await res.json();
                        const select = document.getElementById('audit-employee-filter');
                        if (select) {
                            select.innerHTML = '<option value="">Barcha xodimlar</option>' +
                                employees.map(e => `<option value="${e.id}">${e.full_name || e.username} (@${e.username})</option>`).join('');
                        }
                    }
                }
            },

            debt: {
                selectedClient: null,
                allClients: [],

                // Modalni mijoz bilan ochish (mijozlar jadvalidagi "To'lov" tugmasi uchun)
                async openPaymentModalWithClient(clientId) {
                    // Formani tozalash
                    document.getElementById('debt-amount').value = '';
                    document.getElementById('debt-note').value = '';
                    document.getElementById('debt-remaining-info').style.display = 'none';

                    // Modalni ko'rsatish
                    const modal = new bootstrap.Modal(document.getElementById('modalDebtPayment'));
                    modal.show();

                    // Mijozlarni yuklash va o'sha mijozni tanlash
                    await this.loadClients();

                    // Mijozni tanlash
                    setTimeout(() => {
                        this.selectClient(clientId);
                    }, 100);
                },

                // Mijozlarni yuklash
                async loadClients() {
                    const res = await app.api.fetch('/api/clients');
                    if (res.ok) {
                        this.allClients = await res.json();
                    }
                },

                // Mijozni tanlash (faqat ichki funksiya)
                selectClient(clientId) {
                    const client = this.allClients.find(c => c.id === clientId);
                    if (!client) return;

                    this.selectedClient = client;
                    const debt = Math.abs(client.balance);

                    // Ma'lumotlarni ko'rsatish
                    document.getElementById('debt-client-name').textContent = client.name;
                    document.getElementById('debt-client-phone').textContent = client.phone || 'Tel: yo\'q';
                    document.getElementById('debt-client-debt').textContent = `${debt.toLocaleString()} so'm`;

                    // Tanlangan mijozni ko'rsatish
                    document.getElementById('debt-selected-client').style.display = 'block';
                    document.getElementById('debt-submit-btn').style.display = 'inline-block';

                    // Input ni tozalash
                    document.getElementById('debt-amount').value = '';
                    document.getElementById('debt-remaining-info').style.display = 'none';
                },

                // Qolgan qarzni hisoblash
                calculateRemaining() {
                    if (!this.selectedClient) return;

                    const paymentAmount = parseFloat(document.getElementById('debt-amount').value) || 0;
                    const currentDebt = Math.abs(this.selectedClient.balance);
                    const remaining = currentDebt - paymentAmount;

                    if (paymentAmount > 0) {
                        const remainingDiv = document.getElementById('debt-remaining-info');
                        const remainingSpan = document.getElementById('debt-remaining');

                        if (remaining > 0) {
                            remainingSpan.textContent = `${remaining.toLocaleString()} so'm`;
                            remainingSpan.className = 'fs-5 text-warning';
                        } else if (remaining === 0) {
                            remainingSpan.textContent = 'To\'liq to\'landi ';
                            remainingSpan.className = 'fs-5 text-success';
                        } else {
                            remainingSpan.textContent = 'Ortiqcha to\'lov!';
                            remainingSpan.className = 'fs-5 text-danger';
                        }

                        remainingDiv.style.display = 'block';
                    } else {
                        document.getElementById('debt-remaining-info').style.display = 'none';
                    }
                },

                // To'liq to'lash
                setFullAmount() {
                    if (!this.selectedClient) {
                        Swal.fire('Xato', 'Avval mijozni tanlang', 'warning');
                        return;
                    }

                    const debt = Math.abs(this.selectedClient.balance);
                    document.getElementById('debt-amount').value = debt;
                    this.calculateRemaining();
                },

                // To'lovni saqlash
                async submitPayment() {
                    if (!this.selectedClient) {
                        Swal.fire('Xato', 'Mijoz tanlanmagan', 'error');
                        return;
                    }

                    const amount = parseFloat(document.getElementById('debt-amount').value);
                    const debt = Math.abs(this.selectedClient.balance);

                    // Tekshirish
                    if (!amount || amount <= 0) {
                        Swal.fire('Xato', 'To\'lov summasini kiriting', 'warning');
                        return;
                    }

                    if (amount > debt) {
                        Swal.fire('Xato', `Summa qarzdan ko\'p bo\'lmasligi kerak (${debt.toLocaleString()} so'm)`, 'error');
                        return;
                    }

                    const paymentMethod = document.querySelector('input[name="debt-method"]:checked').value;
                    const note = document.getElementById('debt-note').value;

                    // Tasdiqlash
                    const remaining = debt - amount;
                    const result = await Swal.fire({
                        title: 'To\'lovni tasdiqlaysizmi?',
                        html: `
                            <div class="text-start">
                                <p><strong>Mijoz:</strong> ${this.selectedClient.name}</p>
                                <p><strong>Qarz:</strong> ${debt.toLocaleString()} so'm</p>
                                <p><strong>To\'lov:</strong> ${amount.toLocaleString()} so'm</p>
                                <p><strong>Qoladi:</strong> ${remaining.toLocaleString()} so'm</p>
                                <hr>
                                <p><strong>To\'lov usuli:</strong> ${paymentMethod === 'cash' ? ' Naqd' : paymentMethod === 'terminal' ? ' Terminal' : ' O\'tkazma'}</p>
                            </div>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Ha, qabul qilaman',
                        cancelButtonText: 'Bekor qilish',
                        confirmButtonColor: '#28a745'
                    });

                    if (!result.isConfirmed) return;

                    // Yuborish
                    const res = await app.api.fetch(`/api/clients/${this.selectedClient.id}/payment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: amount,
                            payment_method: paymentMethod,
                            note: note || null
                        })
                    });

                    if (res.ok) {
                        const data = await res.json();

                        await Swal.fire({
                            title: 'Muvaffaqiyat! ',
                            html: `
                                <div class="text-start">
                                    <p><strong>To\'lov qabul qilindi</strong></p>
                                    <p>Mijoz: ${this.selectedClient.name}</p>
                                    <p>To\'langan: ${amount.toLocaleString()} so'm</p>
                                    <p>Qolgan qarz: ${Math.abs(data.new_balance).toLocaleString()} so'm</p>
                                </div>
                            `,
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 1500
                        });

                        // Modalni yopish
                        bootstrap.Modal.getInstance(document.getElementById('modalDebtPayment')).hide();

                        // Agar mijozlar sahifasida bo'lsa, yangilash
                        if (document.getElementById('section-clients').style.display !== 'none') {
                            await app.api.loadAllClients();
                        }

                        // Shift balansini yangilash
                        await app.loadCurrentShift();
                    } else {
                        const error = await res.json();
                        Swal.fire('Xato', error.detail || 'Xatolik yuz berdi', 'error');
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('%c Do\'kon Tizimi v' + app.version, 'color: #0d6efd; font-size: 16px; font-weight: bold;');
            console.log('%c Yangi funksiyalar: Savdolarni ko\'rish, Vozvrat statistikasi', 'color: #198754;');
            window.app = app; // Expose to global scope for onclick handlers
            app.init();
        });
    </script>

    <!-- CUSTOM CSS MODAL FOR CATEGORIES -->
    <div id="divCategories"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100001; justify-content: center; align-items: start; padding-top: 50px; overflow-y: auto;">
        <div class="card border-primary shadow-lg"
            style="width: 100%; max-width: 900px; animation: popIn 0.3s ease-out; margin-bottom: 50px;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-primary fw-bold"><i class="fa-solid fa-layer-group me-2"></i>Kategoriyalar
                    Boshqaruvi</h5>
                <button type="button" class="btn-close"
                    onclick="document.getElementById('divCategories').style.display='none'"></button>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Add Category Column -->
                    <div class="col-md-5 border-end">
                        <h6 class="text-muted mb-3">Yangi Kategoriya Qo'shish</h6>
                        <div class="card bg-light border-0 p-3">
                            <form onsubmit="app.categories.add(event)">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Nomi</label>
                                    <input type="text" id="cat-name-input" class="form-control" required
                                        placeholder="Masalan: Ichimliklar">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fa fa-plus-circle me-1"></i> Qo'shish
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- List Categories Column -->
                    <div class="col-md-7 ps-4">
                        <h6 class="text-muted mb-3">Mavjud Kategoriyalar</h6>
                        <div class="table-responsive border rounded bg-white"
                            style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Nomi</th>
                                        <th style="width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="table-categories-modal">
                                    <!-- JS loads here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>